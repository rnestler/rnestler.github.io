<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Building an out-of-tree Rust Kernel Module Part Three</title>
        <link rel="stylesheet" href="https://blog.rnstlr.ch/theme/css/main.css" />
        <link href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="blog.rnstlr.ch Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://blog.rnstlr.ch/">blog.rnstlr.ch </a></h1>
                <nav><ul>
                    <li><a href="https://blog.rnstlr.ch/category/2013.html">2013</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2015.html">2015</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2016.html">2016</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2017.html">2017</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2022.html">2022</a></li>
                    <li class="active"><a href="https://blog.rnstlr.ch/category/2023.html">2023</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://blog.rnstlr.ch/building-an-out-of-tree-rust-kernel-module-part-three.html" rel="bookmark"
           title="Permalink to Building an out-of-tree Rust Kernel Module Part Three">Building an out-of-tree Rust Kernel Module Part Three</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-06-15T00:00:00+02:00">
                Published: Do 15 Juni 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://blog.rnstlr.ch/author/rnestler.html">rnestler</a>
        </address>
<p>In <a href="https://blog.rnstlr.ch/category/2023.html">2023</a>.</p>
<p>tags: <a href="https://blog.rnstlr.ch/tag/rust.html">rust</a> <a href="https://blog.rnstlr.ch/tag/kernel.html">kernel</a> <a href="https://blog.rnstlr.ch/tag/linux.html">Linux</a> <a href="https://blog.rnstlr.ch/tag/archlinux.html">ArchLinux</a> </p>
</footer><!-- /.post-info -->      <p>In my last <a href="/building-an-out-of-tree-rust-kernel-module-part-two.html">blog post</a>,
I managed to build an out-of-tree kernel module in Rust for a custom 6.1 Linux
kernel I packaged for ArchLinux:
<a href="https://aur.archlinux.org/packages/linux-rust">https://aur.archlinux.org/packages/linux-rust</a>.</p>
<p>While this worked, I couldn't manage to package the correct metadata to build
the out-of-tree kernel module without a local build of the kernel, which kind
of defeats the purpose of the exercise.</p>
<p>In the meantime Linux 6.2 got released so I thought I'd try again.</p>
<h2>Updating our own ArchLinux kernel</h2>
<p>So I went ahead and updated my <a href="https://aur.archlinux.org/packages/linux-rust">linux-rust</a> package to a 6.2 kernel. While
doing this I tried to stay as close as possible to the default ArchLinux kernel
packages <a href="https://gitlab.archlinux.org/archlinux/packaging/packages/linux/-/blob/6.2.10.arch1-1/config?ref_type=tags">config</a> file to make it generally usable.</p>
<h2>Building the out-of-tree module</h2>
<p>Linux 6.2 changed the module metadata strings from byte arrays to proper
<code>str</code>s. For that we needed to update the kernel module. See:
<a href="https://github.com/Rust-for-Linux/rust-out-of-tree-module/pull/5">https://github.com/Rust-for-Linux/rust-out-of-tree-module/pull/5</a></p>
<h2>Same error as before</h2>
<p>So I went ahead recompiled the kernel, rebooted, tried to compile the kernel
module and got the same error as before:</p>
<div class="highlight"><pre><span></span><code>..Rust-for-Linux/rust-out-of-tree-module (git)-[main] % make LLVM=1
make -C /lib/modules/`uname -r`/build M=$PWD
  RUSTC [M] /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.o
error[E0461]: couldn&#39;t find crate `core` with expected target triple target-12809083303779448358
  |
  = note: the following crate versions were found:
          crate `core`, target triple target-5559158138856098584: /usr/lib/modules/6.2.10-arch1-1-rust/build/rust/libcore.rmeta
</code></pre></div>

<h2>Finding the root cause for the error</h2>
<p>But this time I wanted to find out what the cause for this issue is! It turns
out that it is a bug in rustc, where the file <em>path</em> instead of the <em>content</em>
of the <code>target.json</code> where used. See</p>
<ul>
<li><a href="https://github.com/Rust-for-Linux/linux/issues/792">https://github.com/Rust-for-Linux/linux/issues/792</a></li>
<li><a href="https://github.com/rust-lang/rust/pull/98225">https://github.com/rust-lang/rust/pull/98225</a></li>
</ul>
<h2>Compiling with Rust 1.63.0</h2>
<p>So since this bug got fix in Rust 1.63.0 I decided to try to compile the kernel
with a newer (and thus unsupported, since the Linux kernel uses unstable Rust
features) version.</p>
<p>This will print a scary warning during the build process:</p>
<div class="highlight"><pre><span></span><code>***
*** Rust compiler &#39;rustc&#39; is too new. This may or may not work.
***   Your version:     1.63.0
***   Expected version: 1.62.0
***
</code></pre></div>

<p>Also there were a few warnings from the Rust compiler itself about features
that got now stabilized:</p>
<div class="highlight"><pre><span></span><code>warning: the feature `nll` has been stable since 1.63.0 and no longer requires an attribute to enable
   --&gt; rust/alloc/lib.rs:170:12
    |
170 | #![feature(nll)] // Not necessary, but here to test the `nll` feature.
    |            ^^^
    |
    = note: `#[warn(stable_features)]` on by default
</code></pre></div>

<h2>Successfully building an out-of-tree kernel module!</h2>
<p>So finally I was able to compile the out-of-tree module without a local build
of the kernel:</p>
<div class="highlight"><pre><span></span><code>..Rust-for-Linux/rust-out-of-tree-module (git)-[main] % make LLVM=1
make -C /lib/modules/`uname -r`/build M=$PWD
  RUSTC [M] /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.o
  MODPOST /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/Module.symvers
  CC [M]  /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.mod.o
  LD [M]  /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.ko
</code></pre></div>

<p>Which also loaded successfully:</p>
<div class="highlight"><pre><span></span><code>[125766.698929] rust_out_of_tree: loading out-of-tree module taints kernel.
[125766.698985] rust_out_of_tree: module verification failed: signature and/or required key missing - tainting kernel
[125766.699611] rust_out_of_tree: Rust out-of-tree sample (init)
[125771.403175] rust_out_of_tree: My numbers are [72, 108, 200]
[125771.403183] rust_out_of_tree: Rust out-of-tree sample (exit)
</code></pre></div>

<p>I also spent some time figuring out which parts of the build metadata are
really needed, since previously I just copied the whole <code>rust/</code> folder. In the
end we just need:</p>
<ul>
<li><code>rust/target.json</code> the custom target description</li>
<li><code>rust/*.rmeta</code> the compiled rust libraries</li>
<li><code>rust/*.so</code> the pre-compiled procedural macros</li>
<li><code>rust-toolchain</code> such that we use the same Rust compiler version that was
   used to compile the kernel</li>
</ul>
<h2>Looking forward</h2>
<p>In the meantime Linux 6.3 got released and 6.4 will be released shortly. But it
doesn't look like they will bump the minimum version of Rust needed to compile:
<a href="https://github.com/torvalds/linux/blob/v6.4-rc6/scripts/min-tool-version.sh#L29">https://github.com/torvalds/linux/blob/v6.4-rc6/scripts/min-tool-version.sh#L29</a></p>
<p>But reading <a href="https://rust-for-linux.com/rust-version-policy">https://rust-for-linux.com/rust-version-policy</a> it looks like
there are plans to start tracking the latest Rust release for Linux:</p>
<blockquote>
<p>It remains to be decided how often the Rust version upgrades will land.
Ideally we would track the latest Rust release, but it remains to be seen how
other kernel developers feel about it.</p>
</blockquote>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="http://www.coredump.ch/">coredump</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/rnstlr">twitter</a></li>
                            <li><a href="https://github.com/rnestler">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>