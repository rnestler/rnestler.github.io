<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Improving my Raspberry Pi Based Media System</title>
        <link rel="stylesheet" href="https://blog.rnstlr.ch/theme/css/main.css" />
        <link href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="blog.rnstlr.ch Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://blog.rnstlr.ch/">blog.rnstlr.ch </a></h1>
                <nav><ul>
                    <li><a href="https://blog.rnstlr.ch/category/2013.html">2013</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2015.html">2015</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2016.html">2016</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2017.html">2017</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2022.html">2022</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2023.html">2023</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2024.html">2024</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://blog.rnstlr.ch/drafts/improving-my-raspberry-pi-based-media-system.html" rel="bookmark"
           title="Permalink to Improving my Raspberry Pi Based Media System">Improving my Raspberry Pi Based Media System</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2025-01-19T00:00:00+01:00">
                Published: So 19 Januar 2025
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://blog.rnstlr.ch/author/rnestler.html">rnestler</a>
        </address>
<p>In <a href="https://blog.rnstlr.ch/category/2025.html">2025</a>.</p>
<p>tags: <a href="https://blog.rnstlr.ch/tag/raspberry-pi.html">Raspberry Pi</a> <a href="https://blog.rnstlr.ch/tag/linux.html">Linux</a> <a href="https://blog.rnstlr.ch/tag/archlinux.html">ArchLinux</a> <a href="https://blog.rnstlr.ch/tag/arm.html">ARM</a> <a href="https://blog.rnstlr.ch/tag/snapcast.html">snapcast</a> <a href="https://blog.rnstlr.ch/tag/volumio.html">volumio</a> <a href="https://blog.rnstlr.ch/tag/mopidy.html">mopidy</a> </p>
</footer><!-- /.post-info -->      <p>In <a href="https://blog.rnstlr.ch/creating-a-raspberry-pi-based-media-system.html">a past
blogpost</a>
I described how I did set up a media system based on
<a href="https://github.com/badaix/snapcast">snapcast</a> and
<a href="https://github.com/librespot-org/librespot">librespot</a></p>
<p>What I didn't get to yet was configuring mopidy to play music from my NAS.</p>
<h2>mopidy</h2>
<p>Installing mopidy is as easy as <code>sudo pacman -S mopidy</code>. Configuring snapcast
and mopidy to play music works as follows:</p>
<ol>
<li>
<p>Editing <code>/etc/snapserver.conf</code></p>
<p><code>ini
source = pipe:///run/snapserver/snapfifo?name=mopidy</code></p>
</li>
<li>
<p>Editing <code>/etc/mopidy/mopidy.conf</code> to configure mopidy's audio output</p>
<p><code>ini
[audio]
output = audioresample ! audioconvert ! audio/x-raw,rate=48000,channels=2,format=S16LE ! filesink location=/run/snapserver/snapfifo</code></p>
</li>
</ol>
<p>To be able to play local files I wanted to use the
<a href="https://mopidy.com/ext/local/">Mopidy-Local</a> extension. For that I needed to
install the following packages from the AUR:</p>
<ul>
<li><a href="https://aur.archlinux.org/packages/python-uritools">python-uritools</a> (dependency of mopidy-local)</li>
<li><a href="https://aur.archlinux.org/packages/mopidy-local">mopidy-local</a></li>
</ul>
<p>To get access to the music collection of the NAS I mounted the path system wide
via <code>/etc/fstab</code>.</p>
<p>To not store the credentials in plaintext in <code>/etc/fstab</code> directly I create a
credentials file in <code>/var/lib/private</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># /var/lib/private/nas-cifs-credentials</span>
<span class="na">username</span><span class="o">=</span><span class="s">your_username</span>
<span class="na">password</span><span class="o">=</span><span class="s">your_password</span>
<span class="na">domain</span><span class="o">=</span><span class="s">your_domain</span><span class="w">  </span><span class="c1"># Optional, if applicable</span>
</code></pre></div>

<p>To give mopidy access to the files I looked for its user and group ID</p>
<div class="highlight"><pre><span></span><code>$ cat /etc/passwd|grep mopidy
mopidy:x:46:46:Mopidy User:/var/lib/mopidy:/usr/bin/nologin
</code></pre></div>

<p>and put it together like this:</p>
<div class="highlight"><pre><span></span><code>#/etc/fstab
//$IP_OF_NAS/$PATH_TO_MUSIC  /mnt/music  cifs  credentials=/var/lib/private/nas-cifs-credentials,uid=46,gid=46  0  0
</code></pre></div>

<p>Then we need to tell the mopidy extension where our music is:</p>
<div class="highlight"><pre><span></span><code><span class="c1">#/etc/mopidy/mopidy.conf</span>
<span class="k">[local]</span>
<span class="na">media_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/mnt/music</span>
</code></pre></div>

<p>And let it scan the directory</p>
<div class="highlight"><pre><span></span><code>$ sudo mopidyctl local scan
</code></pre></div>

<h3>mopidy-mpd</h3>
<p>To control mopidy I chose to use the <a href="https://mopidy.com/ext/mpd/">mpoidy-mpd</a>
extension, also available from the
<a href="https://aur.archlinux.org/packages/mopidy-mpd">AUR</a></p>
<p>To make it usable we need to make it listen on all interfaces, both IPv4 and
IPv6:</p>
<div class="highlight"><pre><span></span><code><span class="k">[mpd]</span>
<span class="na">hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">::</span>
</code></pre></div>

<p>Trying to use it quickly revealed, that the plugin is quite outdated and won't
work with newer <code>mpd</code> clients:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mpc
warning:<span class="w"> </span>MPD<span class="w"> </span><span class="m">0</span>.21<span class="w"> </span>required
mpd<span class="w"> </span>version:<span class="w"> </span><span class="m">0</span>.19.0
</code></pre></div>

<p>Looking at GitHub I found <a href="https://github.com/mopidy/mopidy-mpd/issues/68">https://github.com/mopidy/mopidy-mpd/issues/68</a> and
<a href="https://github.com/mopidy/mopidy-mpd/issues/47">https://github.com/mopidy/mopidy-mpd/issues/47</a> which confirmed that.</p>
<h3>mopidy-iris</h3>
<p><a href="https://github.com/jaedb/Iris/">mopidy-iris</a> looked like a popolar and
well-maintained web interface for mopidy.</p>
<h2>Notes</h2>
<ul>
<li>Adding the snapcast dashboard to home assistant</li>
<li>Adding the snapcast integration</li>
</ul>
<h2>New stuff</h2>
<ul>
<li><a href="https://github.com/music-assistant/server">https://github.com/music-assistant/server</a></li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="http://www.coredump.ch/">coredump</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/rnstlr">twitter</a></li>
                            <li><a href="https://github.com/rnestler">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>