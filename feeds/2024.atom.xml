<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>blog.rnstlr.ch - 2024</title><link href="https://blog.rnstlr.ch/" rel="alternate"/><link href="https://blog.rnstlr.ch/feeds/2024.atom.xml" rel="self"/><id>https://blog.rnstlr.ch/</id><updated>2024-09-29T00:00:00+02:00</updated><entry><title>Adding AdGuard Home to my Home Assistant</title><link href="https://blog.rnstlr.ch/adding-adguard-home-to-my-home-assistant.html" rel="alternate"/><published>2024-09-29T00:00:00+02:00</published><updated>2024-09-29T00:00:00+02:00</updated><author><name>rnestler</name></author><id>tag:blog.rnstlr.ch,2024-09-29:/adding-adguard-home-to-my-home-assistant.html</id><summary type="html">&lt;p&gt;Setting up a AdGuard Home on my Home Assistant&lt;/p&gt;</summary><content type="html">&lt;p&gt;I recently noticed that home assistant offers an &lt;a href="https://github.com/hassio-addons/addon-adguard-home"&gt;AdGuard Home
add-on&lt;/a&gt;. While I already
block adds and tracking in the web with &lt;a href="https://ublockorigin.com/"&gt;uBlock
Origin&lt;/a&gt; on my laptops and Android phone, I'm still
annoyed and concerned by all the tracking that happens for example by apps.&lt;/p&gt;
&lt;h1&gt;Installing the Add-on&lt;/h1&gt;
&lt;p&gt;Installing is as easy as going to
&lt;a href="http://homeassistant.local:8123/hassio/store"&gt;http://homeassistant.local:8123/hassio/store&lt;/a&gt; and selecting the AdGuard Home
add-on.&lt;/p&gt;
&lt;p&gt;According to the &lt;a href="https://github.com/hassio-addons/addon-adguard-home/blob/main/adguard/DOCS.md"&gt;AdGuard Home add-on install
docs&lt;/a&gt;
one should configure the network to use a static IP address:
&lt;a href="http://homeassistant.local:8123/config/network"&gt;http://homeassistant.local:8123/config/network&lt;/a&gt;&lt;/p&gt;
&lt;center&gt;
![The Home Assistant network configuration]({static}/images/home_assistant/home_assistant_network_configuration.png)
&lt;/center&gt;

&lt;h1&gt;Configuring AdGuard Home&lt;/h1&gt;
&lt;p&gt;For some reason the AdGuard Home add-on only listens on the local interface
instead of all interfaces so it won't be reachable from outside. As instructed
by &lt;a href="https://community.home-assistant.io/t/adguard-listening-on-127-0-0-1-instead-of-the-hassio-ip/310137/9"&gt;https://community.home-assistant.io/t/adguard-listening-on-127-0-0-1-instead-of-the-hassio-ip/310137/9&lt;/a&gt;
I changed the add-on configuration accordingly:&lt;/p&gt;
&lt;center&gt;
![The Home Assistant AdGuard add-on configuration]({static}/images/home_assistant/adguard_home_addon_configuration.png){width=80%}
&lt;/center&gt;

&lt;h1&gt;Configuring Router&lt;/h1&gt;
&lt;p&gt;There are two main ways to set up your router when wanting to use AdGuard Home:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Adding it as the DNS server your router uses&lt;/li&gt;
&lt;li&gt;Adding it as the DNS server that's distributed via DHCP&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The first option has the advantage that local names will still be resolved by
the router, while the second one gives better statistics on which clients use
the AdGuard Home DNS server.&lt;/p&gt;
&lt;p&gt;Since I didn't want to break stuff in my network I decided to first go with
option one. Also I kept one of the original DNS servers just in case for the
first test run.&lt;/p&gt;
&lt;center&gt;
![Router DNS configuration]({static}/images/home_assistant/adguard_home_router_configuration.png){width=80%}
&lt;/center&gt;

&lt;h1&gt;Statistics&lt;/h1&gt;
&lt;p&gt;After a few days of usage without any problems the statistics looked like this:&lt;/p&gt;
&lt;center&gt;
![AdGuard statistics]({static}/images/home_assistant/adguard_home_statistics.png){width=80%}
&lt;/center&gt;

&lt;p&gt;As you can see there are quite some blocked requests and all request originate
from one client, my router.&lt;/p&gt;
&lt;h1&gt;Use AdGuard Directly as the DNS Server&lt;/h1&gt;
&lt;p&gt;Since the usage went without any problems I decided to configure my router to
directly use AdGuard Home as the DNS server for its clients.&lt;/p&gt;
&lt;center&gt;
![Router DHCP configuration]({static}/images/home_assistant/adguard_home_router_configuration_2.png)
&lt;/center&gt;

&lt;p&gt;To make sure that the important local names still resolve (NAS, HomeAssistant,
SnapCast, ...) I added them manually as DNS rewrites.&lt;/p&gt;
&lt;center&gt;
![Router DHCP configuration]({static}/images/home_assistant/adguard_home_dns_rewrites.png){width=80%}
&lt;/center&gt;

&lt;p&gt;When using the DNS server directly we see in the statistics which clients
create the most DNS queries and can also get some insight in what domains are
queried by the WiFi switches for example.&lt;/p&gt;
&lt;center&gt;
![AdGuard statistics for individual clients]({static}/images/home_assistant/adguard_home_statistics_2.png){width=80%}
&lt;/center&gt;

&lt;h1&gt;IPv6 troubles&lt;/h1&gt;
&lt;p&gt;I also noticed that around 25% of the requests are still coming from the
router. Since all clients should use the AdGuard DNS server directly, this
seemed a bit strange. It turns out there are two reasons for that:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;HomeAssistant itself is configured to use the router DNS directly, which is
    probably smart to avoid trouble if the AdGuard DNS server would misbehave.&lt;/li&gt;
&lt;li&gt;My router advertises IPv6 DNS servers as well, but doesn't allow to change
    them in the configuration, thus it still promotes itself as the DNS server
    there.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I found out about the IPv6 thing when I looked into the &lt;code&gt;systemd-resolve&lt;/code&gt;
status:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ systemd-resolve --status
Global
           Protocols: +LLMNR +mDNS -DNSOverTLS DNSSEC=no/unsupported
    resolv.conf mode: foreign
Fallback DNS Servers: 1.1.1.1#cloudflare-dns.com 9.9.9.9#dns.quad9.net 8.8.8.8#dns.google 2606:4700:4700::1111#cloudflare-dns.com
                      2620:fe::9#dns.quad9.net 2001:4860:4860::8888#dns.google

Link 2 (enp38s0)
    Current Scopes: none
         Protocols: -DefaultRoute +LLMNR mDNS=resolve -DNSOverTLS DNSSEC=no/unsupported

Link 4 (wlan0)
    Current Scopes: DNS LLMNR/IPv4 LLMNR/IPv6 mDNS/IPv4 mDNS/IPv6
         Protocols: +DefaultRoute +LLMNR mDNS=resolve -DNSOverTLS DNSSEC=no/unsupported
Current DNS Server: $ROUTER_IPv6_ADDRESS
       DNS Servers: $AD_GUARD_IPv4_ADDRESS $ROUTER_IPv6_ADDRESS
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So IPv6 is now available since more then 20 years but there is still very bad
support for it available in network hardware. My options for fixing this include&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Disabling IPv6 on my router&lt;/li&gt;
&lt;li&gt;Deactivating DHCP on my router and use HomeAssistant as my DHCP server&lt;/li&gt;
&lt;li&gt;Override DNS servers on my clients&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;But for now I'll just live with the slightly worse statistics on AdGuard.&lt;/p&gt;</content><category term="2024"/><category term="Raspberry Pi"/><category term="Linux"/><category term="Home Assistant"/><category term="AdGuard"/></entry><entry><title>Creating a Raspberry Pi Based Media System</title><link href="https://blog.rnstlr.ch/creating-a-raspberry-pi-based-media-system.html" rel="alternate"/><published>2024-09-09T00:00:00+02:00</published><updated>2024-09-09T00:00:00+02:00</updated><author><name>rnestler</name></author><id>tag:blog.rnstlr.ch,2024-09-09:/creating-a-raspberry-pi-based-media-system.html</id><summary type="html">&lt;p&gt;Setting up a media system on a Raspberry Pi 3 based on ArchLinux ARM, snapcast and mopidy&lt;/p&gt;</summary><content type="html">&lt;p&gt;For quite some time I wanted to setup a Raspberry Pi based sound system with
which I could do the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Directly connect speakers to it&lt;/li&gt;
&lt;li&gt;Stream audio from various sources&lt;/li&gt;
&lt;li&gt;Connect a small USB based sound mixer&lt;/li&gt;
&lt;li&gt;Run spotifyd&lt;/li&gt;
&lt;li&gt;Play music from my NAS&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Resources&lt;/h1&gt;
&lt;p&gt;Researching a bit I found the following interesting resources&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://hifiberry.com/"&gt;https://hifiberry.com/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://volumio.com/"&gt;https://volumio.com/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/badaix/snapcast"&gt;https://github.com/badaix/snapcast&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://mopidy.com/"&gt;https://mopidy.com/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://techroadtrip.com/audio-software/volumio-vs-moode-vs-picoreplayer/"&gt;http://techroadtrip.com/audio-software/volumio-vs-moode-vs-picoreplayer/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.runeaudio.com/"&gt;https://www.runeaudio.com/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/dbrgn/weltempfaenger/"&gt;https://github.com/dbrgn/weltempfaenger/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.home-assistant.io/blog/2016/02/18/multi-room-audio-with-snapcast/"&gt;https://www.home-assistant.io/blog/2016/02/18/multi-room-audio-with-snapcast/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Hardware&lt;/h1&gt;
&lt;p&gt;For the hardware I settled for&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A Raspberry Pi 3 which I had laying around anyway&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.hifiberry.com/shop/boards/hifiberry-amp2/"&gt;HiFiBerry Amp2&lt;/a&gt;
   which looked very promising and wasn't too expensive&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="My hardware setup" src="https://blog.rnstlr.ch/images/snapcast/raspberry-pi-audio-setup.jpg" width="100%"&gt;&lt;/p&gt;
&lt;h1&gt;Software&lt;/h1&gt;
&lt;p&gt;The first thing I tried was &lt;a href="https://volumio.com/"&gt;volumio&lt;/a&gt;, which directly
offers a convenient Raspberry Pi image which gets you started quickly:
&lt;a href="https://volumio.com/get-started/"&gt;https://volumio.com/get-started/&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;While it was very convenient to get started and verify that the amplifier
works, it seemed to me that the free version is very limited and locked down.
Also the premium price with 80$ (around 70 CHF) per year seemed a bit expensive
to me.&lt;/p&gt;
&lt;p&gt;Since I wanted something which lets me tinker around a bit more I came up with
the following options:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://buildroot.org/"&gt;Buildroot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://archlinuxarm.org/"&gt;ArchLinuxARM&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;While buildroot would probably allow to get a much more minimal system and a
friend of mine had a good experience using it for &lt;a href="https://github.com/dbrgn/weltempfaenger"&gt;his
project&lt;/a&gt;, the guide I found for
&lt;a href="https://github.com/badaix/snapos/blob/master/buildroot-external/README.md"&gt;setting up
snapcast&lt;/a&gt;
seemed out of date and not maintained anymore.
Also I already know ArchLinux and used ArchLinuxARM for my &lt;a href="https://blog.rnstlr.ch/installing-archlinux-arm-on-the-raspberry-pi-3.html"&gt;kodi
system&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Installing ArchLinux ARM&lt;/h2&gt;
&lt;details&gt;
&lt;summary&gt;So I followed the basic install guide.&lt;/summary&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;[alarm@alarmpi ~]$ su
Password:
[root@alarmpi alarm]# pacman-key --init
gpg: /etc/pacman.d/gnupg/trustdb.gpg: trustdb created
gpg: no ultimately trusted keys found
gpg: starting migration from earlier GnuPG versions
gpg: porting secret keys from &amp;#39;/etc/pacman.d/gnupg/secring.gpg&amp;#39; to gpg-agent
gpg: migration succeeded
==&amp;gt; Generating pacman master key. This may take some time.
gpg: Generating pacman keyring master key...
gpg: directory &amp;#39;/etc/pacman.d/gnupg/openpgp-revocs.d&amp;#39; created
gpg: revocation certificate stored as &amp;#39;/etc/pacman.d/gnupg/openpgp-revocs.d/8277D1E09B6B70944D92CD089C16C729F5655E65.rev&amp;#39;
gpg: Done
==&amp;gt; Updating trust database...
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
[root@alarmpi alarm]# pacman-key --populate archlinuxarm
==&amp;gt; Appending keys from archlinuxarm.gpg...
==&amp;gt; Locally signing trusted keys in keyring...
  -&amp;gt; Locally signed 3 keys.
==&amp;gt; Importing owner trust values...
gpg: setting ownertrust to 4
gpg: inserting ownertrust of 4
gpg: setting ownertrust to 4
==&amp;gt; Updating trust database...
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   3  trust: 0-, 0q, 0n, 0m, 0f, 1u
gpg: depth: 1  valid:   3  signed:   1  trust: 0-, 0q, 0n, 3m, 0f, 0u
gpg: depth: 2  valid:   1  signed:   0  trust: 1-, 0q, 0n, 0m, 0f, 0u
[root@alarmpi alarm]# pacman -Syu
:: Synchronizing package databases...
 core                            240.3 KiB   215 KiB/s 00:01 [################################] 100%
 extra                             9.0 MiB  5.62 MiB/s 00:02 [################################] 100%
 community                        45.0   B   236   B/s 00:00 [################################] 100%
 alarm                            94.9 KiB   474 KiB/s 00:00 [################################] 100%
 aur                               9.3 KiB  49.1 KiB/s 00:00 [################################] 100%
:: Starting full system upgrade...
:: Replace raspberrypi-firmware with alarm/raspberrypi-utils? [Y/n]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;



&lt;/details&gt;

&lt;p&gt;I then changed the hostname to avoid the conflict with my existing archlinuxarm
machine in the network and rebooted:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;[root@alarmpi alarm]# hostnamectl hostname muzikskatolo
[root@alarmpi alarm]# reboot
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Setting up the network&lt;/h2&gt;
&lt;p&gt;To get wifi running I installed &lt;code&gt;iwd&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;[root@muzikskatolo alarm]# pacman -S iwd
[root@muzikskatolo alarm]# systemctl enable iwd.service
[root@muzikskatolo alarm]# systemctl start iwd.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Then connected to my wifi&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;[root@muzikskatolo alarm]# iwctl
NetworkConfigurationEnabled: disabled
StateDirectory: /var/lib/iwd
Version: 2.19
[iwd]# station wlan0 scan
[iwd]# station wlan0 connect wifi-ssid
Type the network passphrase for wifi-ssid psk.
Passphrase:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And configured systemd to start DHCP for the interface by creating
&lt;code&gt;/etc/systemd/network/wlan0.network&lt;/code&gt; with the following content:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;[Match]&lt;/span&gt;
&lt;span class="na"&gt;Name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;wlan0&lt;/span&gt;

&lt;span class="k"&gt;[Network]&lt;/span&gt;
&lt;span class="na"&gt;DHCP&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;
&lt;span class="na"&gt;IgnoreCarrierLoss&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;3s&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Followed by&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;[root@muzikskatolo alarm]# systemctl reload systemd-networkd.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Also I disabled waiting for all networks to be online, since the Pi will only
have wifi were I want to place it:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;[root@muzikskatolo alarm]# systemctl disable systemd-networkd-wait-online.service
[root@muzikskatolo alarm]# systemctl enable systemd-networkd-wait-online@wlan0.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Enabling the Audio&lt;/h2&gt;
&lt;p&gt;To get the amp running I enabled the &lt;code&gt;hifiberry-dacplus&lt;/code&gt; &lt;code&gt;dtoverlay&lt;/code&gt; in &lt;code&gt;/boot/config.txt&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# https://www.hifiberry.com/docs/data-sheets/datasheet-amp2/&lt;/span&gt;
&lt;span class="na"&gt;dtoverlay&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;hifiberry-dacplus,slave&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;For the next step I powered down and hooked up the Raspberry Pi to the
hardware.&lt;/p&gt;
&lt;h2&gt;Configuring Audio&lt;/h2&gt;
&lt;p&gt;To be able to test I needed to add the &lt;code&gt;alarm&lt;/code&gt; user to the &lt;code&gt;audio&lt;/code&gt; group:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo usermod -G audio -a alarm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Then I used &lt;code&gt;aplay -l&lt;/code&gt; to find out which device got which card index:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ aplay -l
**** List of PLAYBACK Hardware Devices ****
card 0: vc4hdmi [vc4-hdmi], device 0: MAI PCM i2s-hifi-0 [MAI PCM i2s-hifi-0]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 1: sndrpihifiberry [snd_rpi_hifiberry_dacplus], device 0: HiFiBerry DAC+ HiFi pcm512x-hifi-0 [HiFiBerry DAC+ HiFi pcm512x-hifi-0]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;To route audio by default to the hifiberry device I configured alsa to use
card-1 by default I created &lt;code&gt;/etc/alsa/conf.d/default.conf&lt;/code&gt; with the following
content (&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1"&gt;1&lt;/a&gt;&lt;/sup&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;defaults.pcm.card 1
defaults.ctl.card 1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Then I used &lt;code&gt;speaker-test&lt;/code&gt; to test the speakers&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ speaker-test -c 2

speaker-test 1.2.12

Playback device is default
Stream parameters are 48000Hz, S16_LE, 2 channels
Using 16 octaves of pink noise
Rate set to 48000Hz (requested 48000Hz)
Buffer size range from 8 to 131072
Period size range from 4 to 65536
Periods = 4
was set period_size = 12000
was set buffer_size = 48000
 0 - Front Left
 1 - Front Right
Time per period = 5.007955
 0 - Front Left
 1 - Front Right
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;After connecting my USB audio device I noticed, that the indices of the sound
cards changed:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ aplay -l
**** List of PLAYBACK Hardware Devices ****
card 0: vc4hdmi [vc4-hdmi], device 0: MAI PCM i2s-hifi-0 [MAI PCM i2s-hifi-0]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 1: CODEC [USB AUDIO  CODEC], device 0: USB Audio [USB Audio]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 2: sndrpihifiberry [snd_rpi_hifiberry_dacplus], device 0: HiFiBerry DAC+ HiFi pcm512x-hifi-0 [HiFiBerry DAC+ HiFi pcm512x-hifi-0]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So to get around that I switched the configuration to use the name of the card.
For that we need to use a slightly different syntax:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nx"&gt;pcm&lt;/span&gt;&lt;span class="p"&gt;.!&lt;/span&gt;&lt;span class="k"&gt;default&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="k"&gt;type&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;hw&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nx"&gt;card&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;sndrpihifiberry&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="nx"&gt;ctl&lt;/span&gt;&lt;span class="p"&gt;.!&lt;/span&gt;&lt;span class="k"&gt;default&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="k"&gt;type&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;hw&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nx"&gt;card&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;sndrpihifiberry&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Playing audio from the USB audio device&lt;/h3&gt;
&lt;p&gt;To achieve my goal of playing back the sound from the small USB based sound
mixer I used &lt;code&gt;alsaloop&lt;/code&gt; to redirect the sound from the USB capture device to
the playback device of the HiFiBerry:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;alsaloop -C hw:1,0 -P hw:2,0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Setting up snapcast&lt;/h2&gt;
&lt;p&gt;To stream audio from various sources (including spotify) I decided to use
&lt;a href="https://github.com/badaix/snapcast"&gt;snapcast&lt;/a&gt;. The nice thing is, that it
allows me to play audio synchronized on both my Raspberry Pis.&lt;/p&gt;
&lt;p&gt;Building the &lt;a href="https://aur.archlinux.org/packages/snapcast"&gt;snapcast &lt;code&gt;PKGBUILD&lt;/code&gt;&lt;/a&gt;
directly on the Raspberry Pi failed, since the device doesn't have enough RAM.
So I tried to follow the guides from archlinuxarm to do cross compile builds:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://archlinuxarm.org/wiki/Distcc_Cross-Compiling"&gt;https://archlinuxarm.org/wiki/Distcc_Cross-Compiling&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://archlinuxarm.org/wiki/Distributed_Compiling"&gt;https://archlinuxarm.org/wiki/Distributed_Compiling&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Distcc Master System (Raspberry Pi)&lt;/h4&gt;
&lt;p&gt;For the distributed build, the Raspberry Pi will be the master system. So we
install &lt;code&gt;distcc&lt;/code&gt; on it and configure &lt;code&gt;makepkg&lt;/code&gt; to use it:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;pacman&lt;span class="w"&gt; &lt;/span&gt;-S&lt;span class="w"&gt; &lt;/span&gt;distcc
sudo&lt;span class="w"&gt; &lt;/span&gt;vim&lt;span class="w"&gt; &lt;/span&gt;/etc/makepkg.conf
&lt;span class="c1"&gt;# Edit / add the following lines&lt;/span&gt;
&lt;span class="c1"&gt;# DISTCC_HOSTS=&amp;quot;$IP_OF_SLAVE:3635&amp;quot;&lt;/span&gt;
&lt;span class="c1"&gt;# MAKEFLAGS=&amp;quot;-j4&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;Distcc Slave System (Desktop PC)&lt;/h4&gt;
&lt;p&gt;On the slave system I first tried to install the cross-compile tools manually
like described by the archlinuxarm page, but this failed with cryptic error
messages from the Raspberry Pi while building the package.&lt;/p&gt;
&lt;p&gt;So I followed the guide from the &lt;a href="https://wiki.archlinux.org/title/Distcc#Cross_compiling_with_distcc"&gt;ArchLinux distcc wiki
page&lt;/a&gt;,
which worked perfectly, using the &lt;a href="https://aur.archlinux.org/packages/distccd-alarm-armv7h"&gt;distccd-alarm-armv7h AUR
package&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;yay distccd-alarm-armv7h
sudo systemctl start distccd-armv7h.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This worked out of the box and I could successfully build the snapcast package
and distribute it to my Raspberry Pis.&lt;/p&gt;
&lt;h3&gt;Configuring Snapcast&lt;/h3&gt;
&lt;p&gt;After installing snapcast it showed the following output :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;:: The default setup will create a pipe /tmp/snapfifo.
   Due to recent changes in systemd, pipes in /tmp are by default only
   writable by the owning user (here: sysuser snapserver).
   The safest option is to change the location of the fifo to a
   different location, e.g. /run/snapserver.  This can be done by
   editing /etc/snapserver.conf
   Another possible workaround is to disable the sysctl feature by
   running:
     # sysctl fs.protected_fifos=0
:: Snapcast now has a built-in snapweb control client which is enabled
   by default on a new setup.  This functionality enables a webserver
   on port 1780.  This can be controlled by the doc_root variable in
   /etc/snapserver.conf.
Optional dependencies for snapcast
    python-websocket-client: stream plugin script [installed]
    python-mpd2: stream plugin script
    python-musicbrainzngs: stream plugin script [installed]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So the first thing I did is set the default source to &lt;code&gt;source =
pipe:///run/snapserver/snapfifo?name=default&lt;/code&gt; in &lt;code&gt;/etc/snapserver.conf&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I then started the &lt;code&gt;snapserver&lt;/code&gt; service and started playing white noise trough
the snapfifo:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo systemctl start snapserver.service
cat /dev/urandom &amp;gt; /run/snapserver/snapfifo
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I could then point my smart phone to http://muzikskatolo:1780 and start
streaming the random white noise to test that everything is working.&lt;/p&gt;
&lt;h3&gt;Adding librespot&lt;/h3&gt;
&lt;p&gt;snapcast has out of the box support to spawn librespot. The &lt;a href="https://aur.archlinux.org/packages/librespot"&gt;librespot AUR
package&lt;/a&gt; needed some patching to
be buildable for the Raspberry Pi. While at it I also removed audio backends
and their dependencies which I didn't need:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="gh"&gt;diff --git a/PKGBUILD b/PKGBUILD&lt;/span&gt;
&lt;span class="gh"&gt;index 4a10228..61aeef4 100644&lt;/span&gt;
&lt;span class="gd"&gt;--- a/PKGBUILD&lt;/span&gt;
&lt;span class="gi"&gt;+++ b/PKGBUILD&lt;/span&gt;
&lt;span class="gu"&gt;@@ -8,16 +8,17 @@ pkgver=0.4.2&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;_commit=22f8aed
&lt;span class="w"&gt; &lt;/span&gt;pkgrel=1
&lt;span class="w"&gt; &lt;/span&gt;pkgdesc=&amp;#39;Open source client library for Spotify&amp;#39;
&lt;span class="gd"&gt;-arch=(&amp;#39;x86_64&amp;#39; &amp;#39;aarch64&amp;#39;)&lt;/span&gt;
&lt;span class="gi"&gt;+arch=(&amp;#39;armv7h&amp;#39; &amp;#39;x86_64&amp;#39; &amp;#39;aarch64&amp;#39;)&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;url=&amp;#39;https://github.com/librespot-org/librespot&amp;#39;
&lt;span class="w"&gt; &lt;/span&gt;license=(&amp;#39;MIT&amp;#39;)
&lt;span class="w"&gt; &lt;/span&gt;depends=(
&lt;span class="w"&gt; &lt;/span&gt;       &amp;#39;alsa-lib&amp;#39;
&lt;span class="gd"&gt;-       &amp;#39;gst-plugins-base-libs&amp;#39;&lt;/span&gt;
&lt;span class="gd"&gt;-       &amp;#39;jack&amp;#39;&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;       &amp;#39;libpulse&amp;#39;
&lt;span class="gd"&gt;-       &amp;#39;portaudio&amp;#39;&lt;/span&gt;
&lt;span class="gd"&gt;-       &amp;#39;sdl2&amp;#39;)&lt;/span&gt;
&lt;span class="gi"&gt;+)&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;makedepends=(&amp;#39;cargo&amp;#39; &amp;#39;git&amp;#39;)
&lt;span class="w"&gt; &lt;/span&gt;source=(&amp;quot;$pkgname::git+$url#commit=$_commit?signed&amp;quot;)
&lt;span class="w"&gt; &lt;/span&gt;sha256sums=(&amp;#39;SKIP&amp;#39;)
&lt;span class="gu"&gt;@@ -25,7 +26,7 @@ validpgpkeys=(&amp;#39;EC57B7376EAFF1A0BB56BB0187F5FDE8A56219F4&amp;#39;) ## Roderick van Domber&lt;/span&gt;

&lt;span class="w"&gt; &lt;/span&gt;prepare() {
&lt;span class="w"&gt; &lt;/span&gt;       cd &amp;quot;$pkgname&amp;quot;
&lt;span class="gd"&gt;-       cargo fetch --locked --target &amp;quot;$CARCH-unknown-linux-gnu&amp;quot;&lt;/span&gt;
&lt;span class="gi"&gt;+       cargo fetch --locked&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;}

&lt;span class="w"&gt; &lt;/span&gt;build() {
&lt;span class="gu"&gt;@@ -33,7 +34,7 @@ build() {&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;       export CARGO_TARGET_DIR=target
&lt;span class="w"&gt; &lt;/span&gt;       cd &amp;quot;$pkgname&amp;quot;
&lt;span class="w"&gt; &lt;/span&gt;       cargo build --release --frozen --features \
&lt;span class="gd"&gt;-               alsa-backend,portaudio-backend,pulseaudio-backend,jackaudio-backend,rodio-backend,rodiojack-backend,sdl-backend,gstreamer-backend&lt;/span&gt;
&lt;span class="gi"&gt;+               alsa-backend,pulseaudio-backend,rodio-backend&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;}

&lt;span class="w"&gt; &lt;/span&gt;## 0 tests
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Due to some random spotify changes &lt;a href="https://github.com/librespot-org/librespot/issues/972#issuecomment-2320943137"&gt;librespot stopped
working&lt;/a&gt;
after a few days and I had to use the &lt;a href="https://aur.archlinux.org/packages/librespot-git"&gt;librespot-git AUR
package&lt;/a&gt; which continued to
work and also didn't need any changes to the &lt;code&gt;PKGBUILD&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Adding librespot to snapcast was as easy as adding the following source to
&lt;code&gt;/etc/snapserver.conf&lt;/code&gt; (&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2"&gt;2&lt;/a&gt;&lt;/sup&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;source = librespot:///usr/bin/librespot?name=librespot&amp;amp;devicename=Snapcast
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I then did setup the &lt;code&gt;snapclient&lt;/code&gt; on my existing kodi Raspberry Pi and on the
Pi where also the snapserver runs:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# /etc/default/snapclient on kodi system&lt;/span&gt;
&lt;span class="nv"&gt;SNAPCLIENT_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;--host &lt;/span&gt;&lt;span class="nv"&gt;$IP_OF_SNAPSERVER&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# /etc/default/snapclient on muzikskatolo&lt;/span&gt;
&lt;span class="nv"&gt;SNAPCLIENT_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;--host 127.0.0.1 -s 13&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;On muzikskatolo snapclient didn't choose the correct output device so I looked
at the output of &lt;code&gt;snapclient -l&lt;/code&gt; and hard-coded it in the options:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;# lots of other devices
13: sysdefault:CARD=sndrpihifiberry
snd_rpi_hifiberry_dacplus, HiFiBerry DAC+ HiFi pcm512x-hifi-0
Default Audio Device
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Another thing I had to change was the &lt;code&gt;bind_to_address&lt;/code&gt; of the &lt;code&gt;snapserver&lt;/code&gt;
(&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3"&gt;3&lt;/a&gt;&lt;/sup&gt;) so that it also listens to incoming IPv6 traffic:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;[http]&lt;/span&gt;
&lt;span class="na"&gt;bind_to_address&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;::&lt;/span&gt;
&lt;span class="k"&gt;[tcp]&lt;/span&gt;
&lt;span class="na"&gt;bind_to_address&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;::&lt;/span&gt;
&lt;span class="k"&gt;[stream]&lt;/span&gt;
&lt;span class="na"&gt;bind_to_address&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;::&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I now enjoy nice multi-room synced audio while being able to easily control
volume from my smart phone:&lt;/p&gt;
&lt;center&gt;
![Snapcast web interface]({static}/images/snapcast/snapcast-webinterface.png){width=80%}
&lt;/center&gt;

&lt;h2&gt;Outlook&lt;/h2&gt;
&lt;p&gt;The next things I want to look at is setting up &lt;a href="https://mopidy.com/"&gt;mopidy&lt;/a&gt;
to stream music from my NAS and also to integrate snapcast into &lt;a href="https://blog.rnstlr.ch/setting-up-home-assistant-on-the-raspberry-pi-3.html"&gt;my home
assistant
setup&lt;/a&gt;.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;See also &lt;a href="https://wiki.archlinux.org/title/Advanced_Linux_Sound_Architecture#Setting_the_default_sound_card_via_defaults_node"&gt;https://wiki.archlinux.org/title/Advanced_Linux_Sound_Architecture#Setting_the_default_sound_card_via_defaults_node&lt;/a&gt;&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;See also &lt;a href="https://github.com/badaix/snapcast/blob/develop/doc/configuration.md#librespot"&gt;https://github.com/badaix/snapcast/blob/develop/doc/configuration.md#librespot&lt;/a&gt;&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;See also &lt;a href="https://github.com/badaix/snapcast/issues/518#issuecomment-569143476"&gt;https://github.com/badaix/snapcast/issues/518#issuecomment-569143476&lt;/a&gt;&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</content><category term="2024"/><category term="Raspberry Pi"/><category term="Linux"/><category term="ArchLinux"/><category term="ARM"/><category term="snapcast"/><category term="volumio"/><category term="mopidy"/></entry><entry><title>Switching from wpa_supplicant to iwd on my Raspberry Pi</title><link href="https://blog.rnstlr.ch/switching-from-wpa_supplicant-to-iwd-on-my-raspberry-pi.html" rel="alternate"/><published>2024-07-31T00:00:00+02:00</published><updated>2024-07-31T00:00:00+02:00</updated><author><name>rnestler</name></author><id>tag:blog.rnstlr.ch,2024-07-31:/switching-from-wpa_supplicant-to-iwd-on-my-raspberry-pi.html</id><summary type="html">&lt;p&gt;Switching from the broken &lt;code&gt;wpa_supplicant&lt;/code&gt; to &lt;code&gt;iwd&lt;/code&gt; for my Kodi installation on a Raspberry Pi 3&lt;/p&gt;</summary><content type="html">&lt;p&gt;After upgrading my archlinuxarm based Kodi media center as usual with just
running &lt;code&gt;pacman -Syu&lt;/code&gt; over ssh I didn't suspect anything. But on the next
reboot the system blocked with waiting for wlan0 to get online.&lt;/p&gt;
&lt;p&gt;At first I suspected the kernel or linux-firmware upgrade, since a quick search
found that this caused trouble in the past: &lt;a href="https://archlinuxarm.org/forum/viewtopic.php?t=15833"&gt;firmware update breaks wifi on
Rpi3&lt;/a&gt;&lt;/p&gt;
&lt;h1&gt;Downgrading &lt;code&gt;linux-firmware&lt;/code&gt;&lt;/h1&gt;
&lt;p&gt;Since remote connection was broken I sat with the keyboard in front of the TV
screen and tried to downgrade the &lt;code&gt;linux-firmware&lt;/code&gt; package from the pkg cache:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;pacman&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;U&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;pacman&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;pkg&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;linux&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;firmware&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;20240610.9&lt;/span&gt;&lt;span class="n"&gt;c10a208&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;any&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pkg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tar&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xz&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;My hope for this easy fix were crushed, when the network still didn't start
correctly after the next reboot. So I started to look into system logs with
&lt;code&gt;sudo systemctl status --all&lt;/code&gt; and realized that &lt;code&gt;wpa_supplicant@wlan0.service&lt;/code&gt;
couldn't start.&lt;/p&gt;
&lt;h1&gt;Investigating Further&lt;/h1&gt;
&lt;p&gt;Searching again I found &lt;a href="https://bbs.archlinux.org/viewtopic.php?id=298025"&gt;https://bbs.archlinux.org/viewtopic.php?id=298025&lt;/a&gt;
from 2024-07-25 indicating that WiFi on Broadcom devices seems broken after the
upgrade to &lt;code&gt;wpa_supplicant&lt;/code&gt; 2.11.&lt;/p&gt;
&lt;p&gt;Looking again in &lt;code&gt;/var/cache/pacman/pkg/&lt;/code&gt; I realized that the old
&lt;code&gt;wpa_supplicant&lt;/code&gt; package was missing. Probably since it 2.10 was the current
version when I installed the whole system.&lt;/p&gt;
&lt;p&gt;Moving forward I decided to switch to &lt;code&gt;iwd&lt;/code&gt;, which seems better maintained and
I also use it on my Laptop.&lt;/p&gt;
&lt;h1&gt;Switching to &lt;code&gt;iwd&lt;/code&gt;&lt;/h1&gt;
&lt;p&gt;So I headed to &lt;a href="https://archlinuxarm.org/packages/armv7h/iwd"&gt;https://archlinuxarm.org/packages/armv7h/iwd&lt;/a&gt;, downloaded the
package and its dependency &lt;code&gt;ell&lt;/code&gt; manually, copied it together with the WiFi
configuration from my laptop from &lt;code&gt;/var/lib/iwd/&lt;/code&gt; to a USB flash drive and
installed them:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo mount /dev/sda1 /mnt
sudo pacman -U /mnt/iwd-2.19-1-armv7h.pkg.tar.xz /mnt/ell-0.67-1-armv7h.pkg.tar.xz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Then I replaced &lt;code&gt;wpa_supplicant&lt;/code&gt; with &lt;code&gt;iwd&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;systemctl&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;wpa_supplicant&lt;/span&gt;&lt;span class="nv"&gt;@wlan0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;service&lt;/span&gt;
&lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;systemctl&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;disable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;wpa_supplicant&lt;/span&gt;&lt;span class="nv"&gt;@wlan0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;service&lt;/span&gt;
&lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;pacman&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;Rs&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;wpa_supplicant&lt;/span&gt;
&lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;systemctl&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;enable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;iwd&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;service&lt;/span&gt;
&lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;systemctl&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;start&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;iwd&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;service&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And ðŸŽ‰ working WiFi again on my Kodi system!&lt;/p&gt;</content><category term="2024"/><category term="Raspberry Pi"/><category term="Linux"/><category term="ArchLinux"/><category term="ARM"/><category term="Kodi"/></entry><entry><title>YouTube plugin for Kodi on the Raspberry Pi 3</title><link href="https://blog.rnstlr.ch/youtube-plugin-for-kodi-on-the-raspberry-pi-3.html" rel="alternate"/><published>2024-04-11T00:00:00+02:00</published><updated>2024-04-11T00:00:00+02:00</updated><author><name>rnestler</name></author><id>tag:blog.rnstlr.ch,2024-04-11:/youtube-plugin-for-kodi-on-the-raspberry-pi-3.html</id><summary type="html">&lt;p&gt;Getting the YouTube plugin for Kodi to work on the Raspberry Pi 3&lt;/p&gt;</summary><content type="html">&lt;p&gt;Last year I installed Kodi on my RaspberryPi 3 to use as a media system. While
it runs quite nicely to stream stuff from my NAS with remote controlling from
&lt;a href="https://f-droid.org/packages/org.xbmc.kore/"&gt;Kore&lt;/a&gt;, every now and then I
wanted to play something from YouTube, which didn't work.&lt;/p&gt;
&lt;p&gt;Installing the YouTube plugin always failed with Kodi being unable to install a
dependency called &lt;code&gt;inputstream-adaptive&lt;/code&gt;. Looking at
&lt;a href="https://kodi.tv/addons/omega/inputstream.adaptive/"&gt;https://kodi.tv/addons/omega/inputstream.adaptive/&lt;/a&gt;` it seems, that the plugin
is only available for Windows, OSX and Android.&lt;/p&gt;
&lt;p&gt;Looking at the ArchLinuxARM forums I found
&lt;a href="https://archlinuxarm.org/forum/viewtopic.php?f=60&amp;amp;t=13189&amp;amp;p=59774&amp;amp;hilit=kodi+inputstream#p59774"&gt;https://archlinuxarm.org/forum/viewtopic.php?f=60&amp;amp;t=13189&amp;amp;p=59774&amp;amp;hilit=kodi+inputstream#p59774&lt;/a&gt;
which shows that people built the plugin themselves to get other plugins to
work.&lt;/p&gt;
&lt;h1&gt;Installing from AUR&lt;/h1&gt;
&lt;p&gt;Luckily there is a PKGBUILD available on the AUR:
&lt;a href="https://aur.archlinux.org/packages/kodi-addon-inputstream-adaptive-git"&gt;https://aur.archlinux.org/packages/kodi-addon-inputstream-adaptive-git&lt;/a&gt;. Since
I didn't want to bother with cross-compiling for the Pi I thought I'll just
compile it on the Pi itself: &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;pacman&lt;span class="w"&gt; &lt;/span&gt;-S&lt;span class="w"&gt; &lt;/span&gt;base-devel&lt;span class="w"&gt; &lt;/span&gt;git
git&lt;span class="w"&gt; &lt;/span&gt;clone&lt;span class="w"&gt; &lt;/span&gt;https://aur.archlinux.org/kodi-addon-inputstream-adaptive-git.git
&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;kodi-addon-inputstream-adaptive-git/
makepkg&lt;span class="w"&gt; &lt;/span&gt;-s
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h1&gt;Trouble&lt;/h1&gt;
&lt;p&gt;The first error I ran into was that the build wants to use an unsupported flag
for the compiler:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;==&amp;gt; Starting build()...
-- The C compiler identification is GNU 12.1.0
-- The CXX compiler identification is GNU 12.1.0
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - failed
-- Check for working C compiler: /usr/bin/cc
-- Check for working C compiler: /usr/bin/cc - broken
CMake Error at /usr/share/cmake/Modules/CMakeTestCCompiler.cmake:67 (message):
  The C compiler

    &amp;quot;/usr/bin/cc&amp;quot;

  is not able to compile a simple test program.

  It fails with the following output:

    Change Dir: &amp;#39;/home/alarm/archpkg/kodi-addon-inputstream-adaptive-git/src/kodi-addon-inputstream-adaptive-git/kodi-addon-inputstream-adaptive-git-build/CMakeFiles/CMakeScratch/TryCompile-SzNkS5&amp;#39;

    Run Build Command(s): /usr/bin/cmake -E env VERBOSE=1 /usr/bin/make -f Makefile cmTC_def07/fast
    /usr/bin/make  -f CMakeFiles/cmTC_def07.dir/build.make CMakeFiles/cmTC_def07.dir/build
    make[1]: Entering directory &amp;#39;/home/alarm/archpkg/kodi-addon-inputstream-adaptive-git/src/kodi-addon-inputstream-adaptive-git/kodi-addon-inputstream-adaptive-git-build/CMakeFiles/CMakeScratch/TryCompile-SzNkS5&amp;#39;
    Building C object CMakeFiles/cmTC_def07.dir/testCCompiler.c.o
    /usr/bin/cc   -march=armv7-a -mfloat-abi=hard -mfpu=neon -O2 -pipe -fstack-protector-strong -fno-plt -fexceptions         -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security         -fstack-clash-protection         -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer  -o CMakeFiles/cmTC_def07.dir/testCCompiler.c.o -c /home/alarm/archpkg/kodi-addon-inputstream-adaptive-git/src/kodi-addon-inputstream-adaptive-git/kodi-addon-inputstream-adaptive-git-build/CMakeFiles/CMakeScratch/TryCompile-SzNkS5/testCCompiler.c
    cc: error: unrecognized command-line option &amp;#39;-mno-omit-leaf-frame-pointer&amp;#39;; did you mean &amp;#39;-fno-omit-frame-pointer&amp;#39;?
    make[1]: *** [CMakeFiles/cmTC_def07.dir/build.make:78: CMakeFiles/cmTC_def07.dir/testCCompiler.c.o] Error 1
    make[1]: Leaving directory &amp;#39;/home/alarm/archpkg/kodi-addon-inputstream-adaptive-git/src/kodi-addon-inputstream-adaptive-git/kodi-addon-inputstream-adaptive-git-build/CMakeFiles/CMakeScratch/TryCompile-SzNkS5&amp;#39;
    make: *** [Makefile:127: cmTC_def07/fast] Error 2


  CMake will not be able to correctly generate this project.
Call Stack (most recent call first):
  CMakeLists.txt:5 (project)


-- Configuring incomplete, errors occurred!
==&amp;gt; ERROR: A failure occurred in build().
    Aborting...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The culprit was &lt;code&gt;cc: error: unrecognized command-line option '-mno-omit-leaf-frame-pointer'; did you mean '-fno-omit-frame-pointer'&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;It turns out that it was due to a wrong default configuration in
&lt;code&gt;/etc/makepkg.conf&lt;/code&gt;. This issue was already reported twice in the forums, so I
didn't bother to report it as well:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://archlinuxarm.org/forum/viewtopic.php?f=15&amp;amp;t=16837&amp;amp;p=72357"&gt;https://archlinuxarm.org/forum/viewtopic.php?f=15&amp;amp;t=16837&amp;amp;p=72357&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://archlinuxarm.org/forum/viewtopic.php?f=57&amp;amp;t=16830&amp;amp;p=72344"&gt;https://archlinuxarm.org/forum/viewtopic.php?f=57&amp;amp;t=16830&amp;amp;p=72344&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Removing &lt;code&gt;-mno-omit-leaf-frame-pointer&lt;/code&gt; from &lt;code&gt;/etc/makepkg.conf&lt;/code&gt; got me a bit
further: &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;CMake Error at /usr/share/cmake/Modules/FindPackageHandleStandardArgs.cmake:230 (message):
  Could NOT find RAPIDJSON (missing: RAPIDJSON_INCLUDES)
Call Stack (most recent call first):
  /usr/share/cmake/Modules/FindPackageHandleStandardArgs.cmake:600 (_FPHSA_FAILURE_MESSAGE)
  FindRAPIDJSON.cmake:19 (find_package_handle_standard_args)
  CMakeLists.txt:18 (find_package)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This was just a missing dependency in the PKGBUILD, which I could just install
with &lt;code&gt;sudo pacman -S rapidjson&lt;/code&gt;.&lt;/p&gt;
&lt;h1&gt;Success&lt;/h1&gt;
&lt;p&gt;After the two bumps the build finished without further problems and I could
install the addon:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;pacman&lt;span class="w"&gt; &lt;/span&gt;-U&lt;span class="w"&gt; &lt;/span&gt;kodi-addon-inputstream-adaptive-git-21.4.4.Omega.r9.g109c0e7a-1-armv7h.pkg.tar.xz
sudo&lt;span class="w"&gt; &lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;restart&lt;span class="w"&gt; &lt;/span&gt;kodi.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="Installing the YouTube addon" src="https://blog.rnstlr.ch/images/kodi/kodi-youtube-addon-install.png" width="100%"&gt;&lt;/p&gt;</content><category term="2024"/><category term="Raspberry Pi"/><category term="Linux"/><category term="ArchLinux"/><category term="ARM"/><category term="Kodi"/></entry><entry><title>Setting up Home Assistant on the Raspberry Pi 3</title><link href="https://blog.rnstlr.ch/setting-up-home-assistant-on-the-raspberry-pi-3.html" rel="alternate"/><published>2024-01-06T00:00:00+01:00</published><updated>2024-01-06T00:00:00+01:00</updated><author><name>rnestler</name></author><id>tag:blog.rnstlr.ch,2024-01-06:/setting-up-home-assistant-on-the-raspberry-pi-3.html</id><summary type="html">&lt;p&gt;Setting up Home Assistant to automate stuff at home&lt;/p&gt;</summary><content type="html">&lt;h1&gt;Motivation&lt;/h1&gt;
&lt;p&gt;From my time working at Sensirion I still have a lot of sensors like the &lt;a href="https://www.sensirion.com/products/catalog/SCD4x-CO2-Gadget"&gt;SCD4x
CO2 Gadget&lt;/a&gt; and
&lt;a href="https://sensirion.com/de/produkte/katalog/SHT4x-Smart-Gadget"&gt;SHT4x Smart
Gadget&lt;/a&gt; running.
Also I decided that I want to use smart plugs to power on my coffee machine in
the morning.&lt;/p&gt;
&lt;p&gt;While one can see the sensor data perfectly fine with the &lt;a href="https://play.google.com/store/apps/details?id=com.sensirion.myam"&gt;Sensirion MyAmbience
App&lt;/a&gt; and also
use the specific apps for the smart plugs, I wanted a bit more integration for
everything and thus decided to try out &lt;a href="https://www.home-assistant.io"&gt;Home
Assistant&lt;/a&gt;.&lt;/p&gt;
&lt;h1&gt;Installing Home Assistant&lt;/h1&gt;
&lt;p&gt;Installing Home Assistant on a Raspberry Pi is very easy: Just follow the guide
at &lt;a href="https://www.home-assistant.io/installation/raspberrypi"&gt;https://www.home-assistant.io/installation/raspberrypi&lt;/a&gt;. Since I didn't
want to use the GUI tools to flash the SD card I used the command line
directly:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$&lt;span class="w"&gt; &lt;/span&gt;wget&lt;span class="w"&gt; &lt;/span&gt;https://github.com/home-assistant/operating-system/releases/download/11.3/haos_rpi3-64-11.3.img.xz
$&lt;span class="w"&gt; &lt;/span&gt;xz&lt;span class="w"&gt; &lt;/span&gt;--decompress&lt;span class="w"&gt; &lt;/span&gt;--stdout&lt;span class="w"&gt; &lt;/span&gt;haos_rpi3-64-11.3.img.xz&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dd&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;of&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/sda&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;bs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;64k&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;oflag&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dsync&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;status&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;progress
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;After that I inserted the SD card into the Raspberry Pi and plugged in power.&lt;/p&gt;
&lt;h1&gt;Setting it up&lt;/h1&gt;
&lt;p&gt;I mostly followed the guide at
&lt;a href="https://www.home-assistant.io/getting-started/onboarding/"&gt;https://www.home-assistant.io/getting-started/onboarding/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;When connecting to &lt;a href="http://homeassistant.local:8123/"&gt;http://homeassistant.local:8123/&lt;/a&gt; I was greeted by the
setup screen:&lt;/p&gt;
&lt;p&gt;&lt;img alt="Home Assistant Setup Screen" src="https://blog.rnstlr.ch/images/home_assistant/preparing-home-assistant.png"&gt;&lt;/p&gt;
&lt;p&gt;This setup screen seemed stuck at the following step in the logs:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;supervisor&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;manager&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;information&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;reload&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;completed&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;details&gt;
&lt;summary&gt;Full logs&lt;/summary&gt;

&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;s6-rc: info: service s6rc-oneshot-runner: starting
s6-rc: info: service s6rc-oneshot-runner successfully started
s6-rc: info: service fix-attrs: starting
s6-rc: info: service fix-attrs successfully started
s6-rc: info: service legacy-cont-init: starting
cont-init: info: running /etc/cont-init.d/udev.sh
INFO: Using udev information from host
cont-init: info: /etc/cont-init.d/udev.sh exited 0
s6-rc: info: service legacy-cont-init successfully started
s6-rc: info: service legacy-services: starting
services-up: info: copying legacy longrun supervisor (no readiness notification)
services-up: info: copying legacy longrun watchdog (no readiness notification)
s6-rc: info: service legacy-services successfully started
INFO: Starting local supervisor watchdog...
[__main__] Initializing Supervisor setup
[supervisor.docker.network] Can&amp;#39;t find Supervisor network, creating a new network
[supervisor.bootstrap] Seting up coresys for machine: raspberrypi3-64
[supervisor.docker.supervisor] Attaching to Supervisor ghcr.io/home-assistant/aarch64-hassio-supervisor with version 2023.12.0
[supervisor.docker.supervisor] Connecting Supervisor to hassio-network
[supervisor.resolution.evaluate] Starting system evaluation with state initialize
[supervisor.resolution.evaluate] System evaluation complete
[__main__] Setting up Supervisor
[supervisor.api] Starting API on 172.30.32.2
[supervisor.hardware.monitor] Started Supervisor hardware monitor
[supervisor.dbus.manager] Connected to system D-Bus.
[supervisor.dbus.agent] Load dbus interface io.hass.os
[supervisor.dbus.hostname] Load dbus interface org.freedesktop.hostname1
[supervisor.dbus.logind] Load dbus interface org.freedesktop.login1
[supervisor.dbus.network] Load dbus interface org.freedesktop.NetworkManager
[supervisor.dbus.rauc] Load dbus interface de.pengutronix.rauc
[supervisor.dbus.resolved] Load dbus interface org.freedesktop.resolve1
[supervisor.dbus.systemd] Load dbus interface org.freedesktop.systemd1
[supervisor.dbus.timedate] Load dbus interface org.freedesktop.timedate1
[supervisor.host.services] Updating service information
[supervisor.host.sound] Updating PulseAudio information
[supervisor.host.sound] Can&amp;#39;t update PulseAudio data: Failed to connect to pulseaudio server
[supervisor.host.network] Updating local network information
[supervisor.host.apparmor] Loading AppArmor Profiles: {&amp;#39;hassio-supervisor&amp;#39;}
[supervisor.docker.monitor] Started docker events monitor
[supervisor.updater] Fetching update data from https://version.home-assistant.io/stable.json
[supervisor.docker.interface] Found ghcr.io/home-assistant/aarch64-hassio-cli versions: []
[supervisor.docker.interface] Attaching to ghcr.io/home-assistant/aarch64-hassio-cli with version 2023.11.0
[supervisor.plugins.cli] Starting CLI plugin
[supervisor.docker.cli] Starting CLI ghcr.io/home-assistant/aarch64-hassio-cli with version 2023.11.0 - 172.30.32.5
[supervisor.docker.interface] Found ghcr.io/home-assistant/aarch64-hassio-dns versions: []
[supervisor.docker.interface] Attaching to ghcr.io/home-assistant/aarch64-hassio-dns with version 2023.06.2
[supervisor.plugins.dns] Starting CoreDNS plugin
[supervisor.docker.dns] Starting DNS ghcr.io/home-assistant/aarch64-hassio-dns with version 2023.06.2 - 172.30.32.3
[supervisor.plugins.dns] Updated /etc/resolv.conf
[supervisor.docker.interface] Found ghcr.io/home-assistant/aarch64-hassio-audio versions: []
[supervisor.docker.interface] Attaching to ghcr.io/home-assistant/aarch64-hassio-audio with version 2023.12.0
[supervisor.plugins.audio] Starting Audio plugin
[supervisor.docker.audio] Starting Audio ghcr.io/home-assistant/aarch64-hassio-audio with version 2023.12.0 - 172.30.32.4
[supervisor.docker.interface] Found ghcr.io/home-assistant/aarch64-hassio-observer versions: []
[supervisor.docker.interface] Attaching to ghcr.io/home-assistant/aarch64-hassio-observer with version 2023.06.0
[supervisor.plugins.observer] Starting observer plugin
[supervisor.docker.observer] Starting Observer ghcr.io/home-assistant/aarch64-hassio-observer with version 2023.06.0 - 172.30.32.6
[supervisor.docker.interface] Found ghcr.io/home-assistant/aarch64-hassio-multicast versions: []
[supervisor.docker.interface] Attaching to ghcr.io/home-assistant/aarch64-hassio-multicast with version 2023.06.2
[supervisor.plugins.multicast] Starting Multicast plugin
[supervisor.docker.multicast] Starting Multicast ghcr.io/home-assistant/aarch64-hassio-multicast with version 2023.06.2 - Host
[supervisor.homeassistant.secrets] Loaded 0 Home Assistant secrets
[supervisor.docker.interface] No version found for ghcr.io/home-assistant/raspberrypi3-64-homeassistant
[supervisor.homeassistant.core] No Home Assistant Docker image ghcr.io/home-assistant/raspberrypi3-64-homeassistant found.
[supervisor.docker.interface] Attaching to ghcr.io/home-assistant/raspberrypi3-64-homeassistant with version landingpage
[supervisor.homeassistant.core] Using preinstalled landingpage
[supervisor.homeassistant.core] Starting HomeAssistant landingpage
[supervisor.homeassistant.module] Update pulse/client.config: /data/tmp/homeassistant_pulse
[supervisor.docker.homeassistant] Starting Home Assistant ghcr.io/home-assistant/raspberrypi3-64-homeassistant with version landingpage
[supervisor.os.manager] Detect Home Assistant Operating System 11.3 / BootSlot A
[supervisor.store.git] Cloning add-on https://github.com/esphome/home-assistant-addon repository
[supervisor.store.git] Cloning add-on https://github.com/hassio-addons/repository repository
[supervisor.store.git] Cloning add-on https://github.com/home-assistant/addons repository
[supervisor.store] Loading add-ons from store: 72 all - 72 new - 0 remove
[supervisor.addons.manager] Found 0 installed add-ons
[supervisor.backups.manager] Found 0 backup files
[supervisor.discovery] Loaded 0 messages
[supervisor.ingress] Loaded 0 ingress sessions
[supervisor.resolution.check] Starting system checks with state setup
[supervisor.resolution.check] System checks complete
[supervisor.resolution.evaluate] Starting system evaluation with state setup
[supervisor.resolution.evaluate] System evaluation complete
[supervisor.jobs] &amp;#39;ResolutionFixup.run_autofix&amp;#39; blocked from execution, system is not running - setup
[supervisor.resolution.evaluate] Starting system evaluation with state setup
[supervisor.resolution.evaluate] System evaluation complete
[__main__] Running Supervisor
[supervisor.os.manager] Rauc: A - marked slot kernel.0 as good
[supervisor.addons.manager] Phase &amp;#39;initialize&amp;#39; starting 0 add-ons
[supervisor.addons.manager] Phase &amp;#39;system&amp;#39; starting 0 add-ons
[supervisor.addons.manager] Phase &amp;#39;services&amp;#39; starting 0 add-ons
[supervisor.core] Skipping start of Home Assistant
[supervisor.addons.manager] Phase &amp;#39;application&amp;#39; starting 0 add-ons
[supervisor.misc.tasks] All core tasks are scheduled
[supervisor.core] Supervisor is up and running
[supervisor.homeassistant.core] Home Assistant setup
[supervisor.docker.interface] Updating image ghcr.io/home-assistant/raspberrypi3-64-homeassistant:landingpage to ghcr.io/home-assistant/raspberrypi3-64-homeassistant:2024.1.1
[supervisor.docker.interface] Downloading docker image ghcr.io/home-assistant/raspberrypi3-64-homeassistant with tag 2024.1.1.
[supervisor.host.info] Updating local host information
[supervisor.resolution.check] Starting system checks with state running
[supervisor.resolution.checks.base] Run check for dns_server_failed/dns_server
[supervisor.resolution.checks.base] Run check for pwned/addon
[supervisor.resolution.checks.base] Run check for ipv4_connection_problem/system
[supervisor.resolution.checks.base] Run check for dns_server_ipv6_error/dns_server
[supervisor.resolution.checks.base] Run check for security/core
[supervisor.resolution.checks.base] Run check for docker_config/system
[supervisor.resolution.checks.base] Run check for trust/supervisor
[supervisor.resolution.checks.base] Run check for no_current_backup/system
[supervisor.resolution.module] Create new suggestion create_full_backup - system / None
[supervisor.resolution.module] Create new issue no_current_backup - system / None
[supervisor.resolution.checks.base] Run check for free_space/system
[supervisor.resolution.checks.base] Run check for multiple_data_disks/system
[supervisor.resolution.check] System checks complete
[supervisor.resolution.evaluate] Starting system evaluation with state running
[supervisor.resolution.evaluate] System evaluation complete
[supervisor.resolution.fixup] Starting system autofix at state running
[supervisor.resolution.fixup] System autofix complete
[supervisor.host.services] Updating service information
[supervisor.host.network] Updating local network information
[supervisor.host.sound] Updating PulseAudio information
[supervisor.host.manager] Host information reload completed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;/details&gt;

&lt;p&gt;But after like 10 minutes (which the screen tells you it can take) it
continued.&lt;/p&gt;
&lt;h1&gt;Configuring&lt;/h1&gt;
&lt;p&gt;One of the first things I noticed after setting up the basic system is that:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I needed to replace the USB power cable, since the RPI Power status reported a problem&lt;/li&gt;
&lt;li&gt;Bluetooth seems broken...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;While I could easily fix the power supply issue with a different USB cable, I
couldn't figure out what the issue with bluetooth is. Looking at the
bugtrackers of Home Assistant did reveal quite some issues that people are having with bluetooth:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/home-assistant/core/issues?q=is%3Aissue+is%3Aopen+bluetooth"&gt;https://github.com/home-assistant/core/issues?q=is%3Aissue+is%3Aopen+bluetooth&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/home-assistant/operating-system/issues?q=bluetooth+is%3Aopen+label%3Aboard%2Fraspberrypi"&gt;https://github.com/home-assistant/operating-system/issues?q=bluetooth+is%3Aopen+label%3Aboard%2Fraspberrypi&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I then remembered that I read the following on &lt;a href="https://archlinuxarm.org/platforms/armv8/broadcom/raspberry-pi-3"&gt;https://archlinuxarm.org/platforms/armv8/broadcom/raspberry-pi-3&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ARMv7 Installation&lt;/p&gt;
&lt;p&gt;Use this installation if you require any of the vendor's kernel hacks,
overlays, or closed-source GPU blobs and utilities.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;So maybe we can just use the 32bit version of the OS and everything will work
out of the box?&lt;/p&gt;
&lt;p&gt;Turns out it is exactly like that! Just doing the same as above just with the 32bit image worked out of the box:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;wget&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;https&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;github&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;home&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;assistant&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;operating&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;system&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;releases&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;download&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;11.3&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;haos_rpi3&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;11.3&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;img&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xz&lt;/span&gt;
&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;xz&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;decompress&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;haos_rpi3&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;11.3&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;img&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xz&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;dd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;of&lt;/span&gt;&lt;span class="o"&gt;=/&lt;/span&gt;&lt;span class="n"&gt;dev&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;sda&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;bs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;64&lt;/span&gt;&lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;oflag&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;dsync&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;progress&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The sensors immediately showed up as discovered devices and could easily be
added and the values shown:&lt;/p&gt;
&lt;p&gt;&lt;img alt="CO2 measurement" src="https://blog.rnstlr.ch/images/home_assistant/co2-sensor.png" width="100%"&gt;&lt;/p&gt;</content><category term="2024"/><category term="Raspberry Pi"/><category term="Linux"/><category term="Home Assistant"/></entry></feed>