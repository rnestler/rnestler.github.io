<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Building an out-of-tree Rust Kernel Module</title>
        <link rel="stylesheet" href="https://blog.rnstlr.ch/theme/css/main.css" />
        <link href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="blog.rnstlr.ch Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://blog.rnstlr.ch/">blog.rnstlr.ch </a></h1>
                <nav><ul>
                    <li><a href="https://blog.rnstlr.ch/category/2013.html">2013</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2015.html">2015</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2016.html">2016</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2017.html">2017</a></li>
                    <li class="active"><a href="https://blog.rnstlr.ch/category/2022.html">2022</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://blog.rnstlr.ch/building-an-out-of-tree-rust-kernel-module.html" rel="bookmark"
           title="Permalink to Building an out-of-tree Rust Kernel Module">Building an out-of-tree Rust Kernel Module</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2022-12-18T00:00:00+01:00">
                Published: So 18 Dezember 2022
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://blog.rnstlr.ch/author/rnestler.html">rnestler</a>
        </address>
<p>In <a href="https://blog.rnstlr.ch/category/2022.html">2022</a>.</p>
<p>tags: <a href="https://blog.rnstlr.ch/tag/rust.html">rust</a> <a href="https://blog.rnstlr.ch/tag/kernel.html">kernel</a> </p>
</footer><!-- /.post-info -->      <p>With the release of <a href="https://lwn.net/Articles/917504/">Linux 6.1</a> minimal Rust
support landed and it should be possible to <del>easily</del> build a hello
world kernel module in Rust.</p>
<h2>Installing Linux 6.1</h2>
<p>At the time of writing Linux 6.1 was still in testing on ArchLinux, so I
enabled the testing repositories:</p>
<div class="highlight"><pre><span></span><code><span class="gd">--- pacman.conf 2022-12-18 15:25:10.742819293 +0100</span><span class="w"></span>
<span class="gi">+++ /etc/pacman.conf    2022-12-18 00:32:56.404801925 +0100</span><span class="w"></span>
<span class="gu">@@ -69,8 +69,8 @@</span><span class="w"></span>
<span class="w"> </span># repo name header and Include lines. You can add preferred servers immediately<span class="w"></span>
<span class="w"> </span># after the header, and they will be used before the default mirrors.<span class="w"></span>

<span class="gd">-#[testing]</span><span class="w"></span>
<span class="gd">-#Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>
<span class="gi">+[testing]</span><span class="w"></span>
<span class="gi">+Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>

<span class="w"> </span>[core]<span class="w"></span>
<span class="w"> </span>Include = /etc/pacman.d/mirrorlist<span class="w"></span>
<span class="gu">@@ -78,8 +78,8 @@</span><span class="w"></span>
<span class="w"> </span>[extra]<span class="w"></span>
<span class="w"> </span>Include = /etc/pacman.d/mirrorlist<span class="w"></span>

<span class="gd">-#[community-testing]</span><span class="w"></span>
<span class="gd">-#Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>
<span class="gi">+[community-testing]</span><span class="w"></span>
<span class="gi">+Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>

<span class="w"> </span>[community]<span class="w"></span>
<span class="w"> </span>Include = /etc/pacman.d/mirrorlist<span class="w"></span>
<span class="gu">@@ -87,8 +87,8 @@</span><span class="w"></span>
<span class="w"> </span># If you want to run 32 bit applications on your x86_64 system,<span class="w"></span>
<span class="w"> </span># enable the multilib repositories as required here.<span class="w"></span>

<span class="gd">-#[multilib-testing]</span><span class="w"></span>
<span class="gd">-#Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>
<span class="gi">+[multilib-testing]</span><span class="w"></span>
<span class="gi">+Include = /etc/pacman.d/mirrorlist</span><span class="w"></span>

<span class="w"> </span>[multilib]<span class="w"></span>
<span class="w"> </span>Include = /etc/pacman.d/mirrorlist<span class="w"></span>
</code></pre></div>

<h2>A first start</h2>
<p>Since I just want to play around I decided to build an out-of-tree Rust module.
Luckily there is an example module available for that already:
https://github.com/Rust-for-Linux/rust-out-of-tree-module.</p>
<p>So I went ahead, cloned the repo and tried to just execute make:</p>
<div class="highlight"><pre><span></span><code>rust-out-of-tree-module (git)-[main] % make
make -C /lib/modules/`uname -r`/build M=$PWD
make[1]: Entering directory &#39;/usr/lib/modules/6.1.0-arch1-1/build&#39;
  RUSTC [M] /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.o
error: target file &quot;./rust/target.json&quot; does not exist

make[2]: *** [scripts/Makefile.build:307: /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.o] Error 1
make[1]: *** [Makefile:1992: /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module] Error 2
make[1]: Leaving directory &#39;/usr/lib/modules/6.1.0-arch1-1/build&#39;
make: *** [Makefile:6: default] Error 2
</code></pre></div>

<p>Well...</p>
<p>Reading through
https://www.kernel.org/doc/html/latest/rust/quick-start.html
it seemed that I have everything I need to get started.</p>
<p>The README mentions the following though:</p>
<blockquote>
<p>The kernel tree (KDIR) requires the Rust metadata to be available. These are
generated during the kernel build, but may not be available for
installed/distributed kernels (the scripts that install/distribute kernel
headers etc. for the different package systems and Linux distributions are
not updated to take into account Rust support yet).</p>
</blockquote>
<h2>Trying an in-kernel build</h2>
<p>To check if it is just a tooling issue I cloned the
https://github.com/Rust-for-Linux/linux repo and executed the check according
to the documentation:</p>
<div class="highlight"><pre><span></span><code>Rust-for-Linux/linux (git)-[rust] % make LLVM=1 rustavailable
***
*** Rust compiler &#39;rustc&#39; is too new. This may or may not work.
***   Your version:     1.66.0
***   Expected version: 1.62.0
***
***
*** Rust bindings generator &#39;bindgen&#39; is too new. This may or may not work.
***   Your version:     0.63.0
***   Expected version: 0.56.0
***
Rust is available!
</code></pre></div>

<p>Since my toolchain seems to new I installed the older versions with</p>
<div class="highlight"><pre><span></span><code>rustup override <span class="nb">set</span> <span class="k">$(</span>scripts/min-tool-version.sh rustc<span class="k">)</span>
rustup component add rust-src
cargo install --locked --version <span class="k">$(</span>scripts/min-tool-version.sh bindgen<span class="k">)</span> bindgen
</code></pre></div>

<p>Then I enabled Rust support with <code>make menuconfig</code> in the <em>General setup</em> menu.
The option is only shown if the toolchain is installed and in my case I also
had to disable the <code>GCC_PLUGINS</code> option.</p>
<p>I then just compiled the whole kernel to test it:</p>
<div class="highlight"><pre><span></span><code>make LLVM=1
</code></pre></div>

<p>This went smoothly, so I continued to build the actual ArchLinux kernel which matches my running kernel:</p>
<div class="highlight"><pre><span></span><code>git remote add archlinux git@github.com:archlinux/linux.git
git fetch archlinux v6.1-arch1
git checkout v6.1-arch1
</code></pre></div>

<p>To be sure I ran <code>make menuconfig</code> again and applied the same changes again.</p>
<p>A few minutes later I had my kernel ready:</p>
<div class="highlight"><pre><span></span><code>Rust-for-Linux/linux (git)-[rust] % make -j8 LLVM=1
...
Kernel: arch/x86/boot/bzImage is ready  (#2)
make -j8 LLVM=1  1557.69s user 133.21s system 745% cpu 3:46.77 total
</code></pre></div>

<h2>Back to the out-of-tree module</h2>
<p>Having successfully built the whole kernel with Rust support I went back to the
<code>rust-out-of-tree-module</code> repository and tried to build it:</p>
<div class="highlight"><pre><span></span><code>Rust-for-Linux/rust-out-of-tree-module (git)-[main] % make KDIR=../linux LLVM=1
make -C ../linux M=$PWD
make[1]: Entering directory &#39;/home/roughl/projects/github/Rust-for-Linux/linux&#39;
  RUSTC [M] /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.o
error: proc macro panicked
  --&gt; /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.rs:7:1
   |
7  | / module! {
8  | |     type: RustOutOfTree,
9  | |     name: &quot;rust_out_of_tree&quot;,
10 | |     author: &quot;Rust for Linux Contributors&quot;,
11 | |     description: &quot;Rust out-of-tree sample&quot;,
12 | |     license: &quot;GPL&quot;,
13 | | }
   | |_^
   |
   = help: message: Expected byte string

error[E0412]: cannot find type `CStr` in this scope
  --&gt; /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.rs:20:29
   |
20 |     fn init(_name: &amp;&#39;static CStr, _module: &amp;&#39;static ThisModule) -&gt; Result&lt;Self&gt; {
   |                             ^^^^ not found in this scope
   |
help: consider importing this struct
   |
5  | use core::ffi::CStr;
   |

error[E0425]: cannot find value `__LOG_PREFIX` in the crate root
  --&gt; /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.rs:21:9
   |
21 |         pr_info!(&quot;Rust out-of-tree sample (init)\n&quot;);
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ not found in the crate root
   |
   = note: this error originates in the macro `$crate::print_macro` (in Nightly builds, run with -Z macro-backtrace for more info)

error[E0425]: cannot find value `__LOG_PREFIX` in the crate root
  --&gt; /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.rs:34:9
   |
34 |         pr_info!(&quot;My numbers are {:?}\n&quot;, self.numbers);
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ not found in the crate root
   |
   = note: this error originates in the macro `$crate::print_macro` (in Nightly builds, run with -Z macro-backtrace for more info)

error[E0425]: cannot find value `__LOG_PREFIX` in the crate root
  --&gt; /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.rs:35:9
   |
35 |         pr_info!(&quot;Rust out-of-tree sample (exit)\n&quot;);
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ not found in the crate root
   |
   = note: this error originates in the macro `$crate::print_macro` (in Nightly builds, run with -Z macro-backtrace for more info)

error[E0050]: method `init` has 2 parameters but the declaration in trait `init` has 1
  --&gt; /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.rs:20:20
   |
20 |     fn init(_name: &amp;&#39;static CStr, _module: &amp;&#39;static ThisModule) -&gt; Result&lt;Self&gt; {
   |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected 1 parameter, found 2
   |
   = note: `init` from trait: `fn(&amp;&#39;static kernel::ThisModule) -&gt; core::result::Result&lt;Self, kernel::error::Error&gt;`

error: aborting due to 6 previous errors

Some errors have detailed explanations: E0050, E0412, E0425.
For more information about an error, try `rustc --explain E0050`.
make[2]: *** [scripts/Makefile.build:307: /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.o] Error 1
make[1]: *** [Makefile:1992: /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module] Error 2
make[1]: Leaving directory &#39;/home/roughl/projects/github/Rust-for-Linux/linux&#39;
make: *** [Makefile:6: default] Error 2
</code></pre></div>

<p>Looking into the compile errors it seemed that some the <code>fn init</code> signature
changed and that the <code>module!</code> marco expects byte strings.</p>
<p>Changing that:</p>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/rust_out_of_tree.rs b/rust_out_of_tree.rs</span><span class="w"></span>
<span class="gh">index e280409..58cc9ba 100644</span><span class="w"></span>
<span class="gd">--- a/rust_out_of_tree.rs</span><span class="w"></span>
<span class="gi">+++ b/rust_out_of_tree.rs</span><span class="w"></span>
<span class="gu">@@ -6,10 +6,10 @@ use kernel::prelude::*;</span><span class="w"></span>

<span class="w"> </span>module! {<span class="w"></span>
<span class="w"> </span>    type: RustOutOfTree,<span class="w"></span>
<span class="gd">-    name: &quot;rust_out_of_tree&quot;,</span><span class="w"></span>
<span class="gd">-    author: &quot;Rust for Linux Contributors&quot;,</span><span class="w"></span>
<span class="gd">-    description: &quot;Rust out-of-tree sample&quot;,</span><span class="w"></span>
<span class="gd">-    license: &quot;GPL&quot;,</span><span class="w"></span>
<span class="gi">+    name: b&quot;rust_out_of_tree&quot;,</span><span class="w"></span>
<span class="gi">+    author: b&quot;Rust for Linux Contributors&quot;,</span><span class="w"></span>
<span class="gi">+    description: b&quot;Rust out-of-tree sample&quot;,</span><span class="w"></span>
<span class="gi">+    license: b&quot;GPL&quot;,</span><span class="w"></span>
<span class="w"> </span>}<span class="w"></span>

<span class="w"> </span>struct RustOutOfTree {<span class="w"></span>
<span class="gu">@@ -17,7 +17,7 @@ struct RustOutOfTree {</span><span class="w"></span>
<span class="w"> </span>}<span class="w"></span>

<span class="w"> </span>impl kernel::Module for RustOutOfTree {<span class="w"></span>
<span class="gd">-    fn init(_name: &amp;&#39;static CStr, _module: &amp;&#39;static ThisModule) -&gt; Result&lt;Self&gt; {</span><span class="w"></span>
<span class="gi">+    fn init(_module: &amp;&#39;static ThisModule) -&gt; Result&lt;Self&gt; {</span><span class="w"></span>
<span class="w"> </span>        pr_info!(&quot;Rust out-of-tree sample (init)\n&quot;);<span class="w"></span>

<span class="w"> </span>        let mut numbers = Vec::new();<span class="w"></span>
</code></pre></div>

<p>We get a successful build!</p>
<div class="highlight"><pre><span></span><code>Rust-for-Linux/rust-out-of-tree-module (git)-[main] % make KDIR=../linux LLVM=1
make -C ../linux M=$PWD
make[1]: Entering directory &#39;/home/roughl/projects/github/Rust-for-Linux/linux&#39;
  RUSTC [M] /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.o
  MODPOST /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/Module.symvers
  LD [M]  /home/roughl/projects/github/Rust-for-Linux/rust-out-of-tree-module/rust_out_of_tree.ko
make[1]: Leaving directory &#39;/home/roughl/projects/github/Rust-for-Linux/linux&#39;
</code></pre></div>

<p>But trying to load the resulting module fails:</p>
<div class="highlight"><pre><span></span><code>sudo insmod rust_out_of_tree.ko
insmod: ERROR: could not insert module rust_out_of_tree.ko: Invalid module format
</code></pre></div>

<p>We see this in the <code>dmesg</code> output as well:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="mf">24593.691184</span><span class="p">]</span><span class="w"> </span><span class="n">rust_out_of_tree</span><span class="p">:</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">magic</span><span class="w"> </span><span class="s1">&#39;6.1.0-arch1 SMP preempt mod_unload &#39;</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="s1">&#39;6.1.0-arch1-1 SMP preempt mod_unload &#39;</span><span class="w"></span>
</code></pre></div>

<p>Of course we aren't setting the version the same as the ArchLinux kernel. I
copied a few steps from
https://github.com/archlinux/svntogit-packages/blob/packages/linux/trunk/PKGBUILD
to set the same version (we could also just copy the config from there, but
lets see what happens first)</p>
<div class="highlight"><pre><span></span><code>Rust-for-Linux/linux (git)-[tags/v6.1-arch1] % echo &quot;-1&quot; &gt; localversion.10-pkgrel
Rust-for-Linux/linux (git)-[tags/v6.1-arch1] % make -s kernelrelease &gt; version
Rust-for-Linux/linux (git)-[tags/v6.1-arch1] % cat version
6.1.0-arch1-1
</code></pre></div>

<p>It didn't work again:</p>
<div class="highlight"><pre><span></span><code><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span> <span class="ss">(</span><span class="nv">git</span><span class="ss">)</span><span class="o">-</span>[<span class="nv">fix</span><span class="o">-</span><span class="nv">build</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="mi">6</span>.<span class="mi">1</span>] <span class="o">%</span> <span class="nv">sudo</span> <span class="nv">insmod</span> <span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>
<span class="nv">insmod</span>: <span class="nv">ERROR</span>: <span class="nv">could</span> <span class="nv">not</span> <span class="nv">insert</span> <span class="nv">module</span> <span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>: <span class="nv">Unknown</span> <span class="nv">symbol</span> <span class="nv">in</span> <span class="nv">module</span>
</code></pre></div>

<p>The <code>dmesg</code> output shows:</p>
<div class="highlight"><pre><span></span><code>[25300.463334] rust_out_of_tree: Unknown symbol _RNvNtNtCsfATHBUcknU9_6kernel5print14format_strings4INFO (err -2)
[25300.463353] rust_out_of_tree: Unknown symbol _RNvNtCsfATHBUcknU9_6kernel5print11call_printk (err -2)
[25300.463371] rust_out_of_tree: Unknown symbol __rust_dealloc (err -2)
[25300.463386] rust_out_of_tree: Unknown symbol __rust_realloc (err -2)
[25300.463400] rust_out_of_tree: Unknown symbol __rust_alloc (err -2)
[25300.463414] rust_out_of_tree: Unknown symbol _RNvNtCs3yuwAp0waWO_4core9panicking5panic (err -2)
[25300.463428] rust_out_of_tree: Unknown symbol _RNvMs7_NtCs3yuwAp0waWO_4core3fmtNtB5_9Formatter15debug_lower_hex (err -2)
[25300.463442] rust_out_of_tree: Unknown symbol _RNvXsS_NtNtCs3yuwAp0waWO_4core3fmt3numlNtB7_8LowerHex3fmt (err -2)
[25300.463456] rust_out_of_tree: Unknown symbol _RNvMs7_NtCs3yuwAp0waWO_4core3fmtNtB5_9Formatter15debug_upper_hex (err -2)
[25300.463469] rust_out_of_tree: Unknown symbol _RNvXsT_NtNtCs3yuwAp0waWO_4core3fmt3numlNtB7_8UpperHex3fmt (err -2)
[25300.463483] rust_out_of_tree: Unknown symbol _RNvXs2_NtNtNtCs3yuwAp0waWO_4core3fmt3num3implNtB9_7Display3fmt (err -2)
[25300.463497] rust_out_of_tree: Unknown symbol _RNvMs7_NtCs3yuwAp0waWO_4core3fmtNtB5_9Formatter10debug_list (err -2)
[25300.463510] rust_out_of_tree: Unknown symbol _RNvMs5_NtNtCs3yuwAp0waWO_4core3fmt8buildersNtB5_9DebugList5entry (err -2)
[25300.463524] rust_out_of_tree: Unknown symbol _RNvMs5_NtNtCs3yuwAp0waWO_4core3fmt8buildersNtB5_9DebugList6finish (err -2)
[25300.463538] rust_out_of_tree: Unknown symbol _RNvXs_NtCsfATHBUcknU9_6kernel5errorNtB4_5ErrorINtNtCs3yuwAp0waWO_4core7convert4FromNtNtCsdvv6pRyacSq_5alloc11collections15TryReserveErrorE4from (err -2)
[25300.463552] rust_out_of_tree: Unknown symbol _RNvMNtCsfATHBUcknU9_6kernel5errorNtB2_5Error15to_kernel_errno (err -2)
</code></pre></div>

<p>So lets try with the ArchLinux config:</p>
<div class="highlight"><pre><span></span><code>wget https://raw.githubusercontent.com/archlinux/svntogit-packages/packages/linux/trunk/config
make olddefconfig
diff -u config .config
</code></pre></div>

<p>The configuration difference isn't big</p>
<div class="highlight"><pre><span></span><code><span class="gd">--- config  2022-12-18 20:51:38.269359290 +0100</span><span class="w"></span>
<span class="gi">+++ .config 2022-12-18 20:53:48.896025137 +0100</span><span class="w"></span>
<span class="gu">@@ -11,6 +11,7 @@</span><span class="w"></span>
<span class="w"> </span>CONFIG_LD_IS_BFD=y<span class="w"></span>
<span class="w"> </span>CONFIG_LD_VERSION=23900<span class="w"></span>
<span class="w"> </span>CONFIG_LLD_VERSION=0<span class="w"></span>
<span class="gi">+CONFIG_RUST_IS_AVAILABLE=y</span><span class="w"></span>
<span class="w"> </span>CONFIG_CC_CAN_LINK=y<span class="w"></span>
<span class="w"> </span>CONFIG_CC_CAN_LINK_STATIC=y<span class="w"></span>
<span class="w"> </span>CONFIG_CC_HAS_ASM_GOTO_OUTPUT=y<span class="w"></span>
</code></pre></div>

<p>A bit strange that <code>CONFIG_RUST_IS_AVAILABLE=y</code> isn't set, but
<code>CONFIG_HAVE_RUST=y</code> is enabled so all should be good.</p>
<p>Quite some time later we built the ArchLinux kernel as well:</p>
<div class="highlight"><pre><span></span><code>make -j8 LLVM=1  15202.68s user 1464.06s system 800% cpu 34:42.57 total
</code></pre></div>

<p>But this lead to build failures in the kernel module!</p>
<div class="highlight"><pre><span></span><code><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span> <span class="ss">(</span><span class="nv">git</span><span class="ss">)</span><span class="o">-</span>[<span class="nv">fix</span><span class="o">-</span><span class="nv">build</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="mi">6</span>.<span class="mi">1</span>] <span class="o">%</span> <span class="nv">make</span> <span class="nv">KDIR</span><span class="o">=</span>..<span class="o">/</span><span class="nv">linux</span> <span class="nv">LLVM</span><span class="o">=</span><span class="mi">1</span>
<span class="nv">make</span> <span class="o">-</span><span class="nv">C</span> ..<span class="o">/</span><span class="nv">linux</span> <span class="nv">M</span><span class="o">=</span>$<span class="nv">PWD</span>
<span class="nv">make</span>[<span class="mi">1</span>]: <span class="nv">Entering</span> <span class="nv">directory</span> <span class="s1">&#39;</span><span class="s">/home/roughl/projects/github/Rust-for-Linux/linux</span><span class="s1">&#39;</span>
  <span class="nv">MODPOST</span> <span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">Module</span>.<span class="nv">symvers</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">_RNvNtNtCsfATHBUcknU9_6kernel5print14format_strings4INFO</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">_RNvNtCsfATHBUcknU9_6kernel5print11call_printk</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">__rust_dealloc</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">__rust_realloc</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">__rust_alloc</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">_RNvMs7_NtCs3yuwAp0waWO_4core3fmtNtB5_9Formatter15debug_lower_hex</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">_RNvXsS_NtNtCs3yuwAp0waWO_4core3fmt3numlNtB7_8LowerHex3fmt</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">_RNvMs7_NtCs3yuwAp0waWO_4core3fmtNtB5_9Formatter15debug_upper_hex</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">_RNvXsT_NtNtCs3yuwAp0waWO_4core3fmt3numlNtB7_8UpperHex3fmt</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">ERROR</span>: <span class="nv">modpost</span>: <span class="s2">&quot;</span><span class="s">_RNvXs2_NtNtNtCs3yuwAp0waWO_4core3fmt3num3implNtB9_7Display3fmt</span><span class="s2">&quot;</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">rust_out_of_tree</span>.<span class="nv">ko</span>] <span class="nv">undefined</span><span class="o">!</span>
<span class="nv">WARNING</span>: <span class="nv">modpost</span>: <span class="nv">suppressed</span> <span class="mi">5</span> <span class="nv">unresolved</span> <span class="nv">symbol</span> <span class="nv">warnings</span> <span class="nv">because</span> <span class="nv">there</span> <span class="nv">were</span> <span class="nv">too</span> <span class="nv">many</span><span class="ss">)</span>
<span class="nv">make</span>[<span class="mi">2</span>]: <span class="o">***</span> [<span class="nv">scripts</span><span class="o">/</span><span class="nv">Makefile</span>.<span class="nv">modpost</span>:<span class="mi">126</span>: <span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">roughl</span><span class="o">/</span><span class="nv">projects</span><span class="o">/</span><span class="nv">github</span><span class="o">/</span><span class="nv">Rust</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">Linux</span><span class="o">/</span><span class="nv">rust</span><span class="o">-</span><span class="nv">out</span><span class="o">-</span><span class="nv">of</span><span class="o">-</span><span class="nv">tree</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">Module</span>.<span class="nv">symvers</span>] <span class="nv">Error</span> <span class="mi">1</span>
<span class="nv">make</span>[<span class="mi">1</span>]: <span class="o">***</span> [<span class="nv">Makefile</span>:<span class="mi">1944</span>: <span class="nv">modpost</span>] <span class="nv">Error</span> <span class="mi">2</span>
<span class="nv">make</span>[<span class="mi">1</span>]: <span class="nv">Leaving</span> <span class="nv">directory</span> <span class="s1">&#39;</span><span class="s">/home/roughl/projects/github/Rust-for-Linux/linux</span><span class="s1">&#39;</span>
<span class="nv">make</span>: <span class="o">***</span> [<span class="nv">Makefile</span>:<span class="mi">6</span>: <span class="nv">default</span>] <span class="nv">Error</span> <span class="mi">2</span>
</code></pre></div>

<p>This are now the compile time errors of the runtime errors we got before!</p>
<p>Apparently the ArchLinux kernel <em>doesn't</em> have Rust support, despite it beeing
set in the config. Executing  <code>make menuconfig</code> also reveals that options which
conflict with <code>CONFIG_HAVE_RUST=y</code> are enabled:</p>
<div class="highlight"><pre><span></span><code>│ Symbol: RUST [=n]                                                                                                                                  │
│ Type  : bool                                                                                                                                       │
│ Defined at init/Kconfig:1925                                                                                                                       │
│   Prompt: Rust support                                                                                                                             │
│   Depends on: HAVE_RUST [=y] &amp;&amp; RUST_IS_AVAILABLE [=y] &amp;&amp; !MODVERSIONS [=n] &amp;&amp; !GCC_PLUGINS [=y] &amp;&amp; !RANDSTRUCT [=n] &amp;&amp; !DEBUG_INFO_BTF [=y]       │
</code></pre></div>

<p>At this point I'd probably need to compile and run a custom kernel which
actually has Rust support enabled.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="http://www.coredump.ch/">coredump</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/rnstlr">twitter</a></li>
                            <li><a href="https://github.com/rnestler">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>