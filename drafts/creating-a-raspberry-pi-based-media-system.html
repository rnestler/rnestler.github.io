<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Creating a Raspberry Pi Based Media System</title>
        <link rel="stylesheet" href="https://blog.rnstlr.ch/theme/css/main.css" />
        <link href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="blog.rnstlr.ch Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://blog.rnstlr.ch/">blog.rnstlr.ch </a></h1>
                <nav><ul>
                    <li><a href="https://blog.rnstlr.ch/category/2013.html">2013</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2015.html">2015</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2016.html">2016</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2017.html">2017</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2022.html">2022</a></li>
                    <li><a href="https://blog.rnstlr.ch/category/2023.html">2023</a></li>
                    <li class="active"><a href="https://blog.rnstlr.ch/category/2024.html">2024</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://blog.rnstlr.ch/drafts/creating-a-raspberry-pi-based-media-system.html" rel="bookmark"
           title="Permalink to Creating a Raspberry Pi Based Media System">Creating a Raspberry Pi Based Media System</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-08-25T00:00:00+02:00">
                Published: So 25 August 2024
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://blog.rnstlr.ch/author/rnestler.html">rnestler</a>
        </address>
<p>In <a href="https://blog.rnstlr.ch/category/2024.html">2024</a>.</p>
<p>tags: <a href="https://blog.rnstlr.ch/tag/raspberry-pi.html">Raspberry Pi</a> <a href="https://blog.rnstlr.ch/tag/linux.html">Linux</a> <a href="https://blog.rnstlr.ch/tag/archlinux.html">ArchLinux</a> <a href="https://blog.rnstlr.ch/tag/arm.html">ARM</a> <a href="https://blog.rnstlr.ch/tag/snapcast.html">snapcast</a> <a href="https://blog.rnstlr.ch/tag/volumio.html">volumio</a> <a href="https://blog.rnstlr.ch/tag/mopidy.html">mopidy</a> </p>
</footer><!-- /.post-info -->      <p>For quite some time I wanted to setup a Raspberry Pi based sound system with
which I could do the following:</p>
<ul>
<li>Directly connect speakers to it</li>
<li>Stream audio from various sources</li>
<li>Connect a small USB based sound mixer</li>
<li>Run spotifyd</li>
<li>Play music from my NAS</li>
</ul>
<h1>Resources</h1>
<p>Researching a bit I found the following interesting resources</p>
<ul>
<li><a href="https://hifiberry.com/">https://hifiberry.com/</a></li>
<li><a href="https://volumio.com/">https://volumio.com/</a></li>
<li><a href="https://github.com/badaix/snapcast">https://github.com/badaix/snapcast</a></li>
<li><a href="https://mopidy.com/">https://mopidy.com/</a></li>
<li><a href="http://techroadtrip.com/audio-software/volumio-vs-moode-vs-picoreplayer/">http://techroadtrip.com/audio-software/volumio-vs-moode-vs-picoreplayer/</a></li>
<li><a href="https://www.runeaudio.com/">https://www.runeaudio.com/</a></li>
<li><a href="https://github.com/dbrgn/weltempfaenger/">https://github.com/dbrgn/weltempfaenger/</a></li>
</ul>
<h1>Hardware</h1>
<p>For the hardware I settled for</p>
<ul>
<li>A Raspberry Pi 3 which I had laying around anyway</li>
<li><a href="https://www.hifiberry.com/shop/boards/hifiberry-amp2/">HiFiBerry Amp2</a>
   which looked very promising and wasn't too expensive</li>
</ul>
<h1>Software</h1>
<p>The first thing I tried was <a href="https://volumio.com/">volumio</a>, which directly
offers a convenient Raspberry Pi image which gets you started quickly:
<a href="https://volumio.com/get-started/">https://volumio.com/get-started/</a>.</p>
<p>While it was very convenient to get started and verify that the amplifier
works, it seemed to me that the free version is very limited and locked down.
Also the premium price with 80$ (around 70 CHF) per year seemed a bit expensive
to me.</p>
<p>Since I wanted something which lets me tinker around a bit more I came up with
the following options:</p>
<ul>
<li><a href="https://buildroot.org/">Buildroot</a></li>
<li><a href="https://archlinuxarm.org/">ArchLinuxARM</a></li>
</ul>
<p>While buildroot would probably allow to get a much more minimal system and a
friend of mine had a good experience using it for <a href="https://github.com/dbrgn/weltempfaenger">his
project</a>, the guide I found for
<a href="https://github.com/badaix/snapos/blob/master/buildroot-external/README.md">setting up
snapcast</a>
seemed out of date and not maintained anymore.
Also I already know ArchLinux and used ArchLinuxARM for my <a href="https://blog.rnstlr.ch/installing-archlinux-arm-on-the-raspberry-pi-3.html">kodi
system</a>.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># config.txt</span>
<span class="c1">### DO NOT EDIT THIS FILE ###</span>
<span class="c1">### APPLY CUSTOM PARAMETERS TO userconfig.txt ###</span>
<span class="na">initramfs volumio.initrd</span>
<span class="na">gpu_mem</span><span class="o">=</span><span class="s">128</span>
<span class="na">gpu_mem_256</span><span class="o">=</span><span class="s">32</span>
<span class="na">gpu_mem_512</span><span class="o">=</span><span class="s">32</span>
<span class="na">gpu_mem_1024</span><span class="o">=</span><span class="s">128</span>
<span class="na">max_usb_current</span><span class="o">=</span><span class="s">1</span>
<span class="k">[pi5]</span>
<span class="na">usb_max_current_enable</span><span class="o">=</span><span class="s">1</span>
<span class="k">[all]</span>
<span class="na">include volumioconfig.txt</span>
<span class="na">include userconfig.txt</span>

<span class="c1">#### Volumio i2s setting below: do not alter ####</span>
<span class="na">dtoverlay</span><span class="o">=</span><span class="s">hifiberry-dacplus,slave</span>

<span class="c1"># volumioconfig.txt</span>
<span class="c1">### DO NOT EDIT THIS FILE ###</span>
<span class="c1">### APPLY CUSTOM PARAMETERS TO userconfig.txt ###</span>
<span class="k">[cm4]</span>
<span class="na">dtoverlay</span><span class="o">=</span><span class="s">dwc2,dr_mode=host</span>
<span class="na">otg_mode</span><span class="o">=</span><span class="s">1</span>
<span class="k">[pi5]</span>
<span class="na">dtoverlay</span><span class="o">=</span><span class="s">vc4-kms-v3d-pi5</span>
<span class="c1"># dtparam=uart0_console # Disabled by default</span>
<span class="na">dtparam</span><span class="o">=</span><span class="s">nvme</span>
<span class="na">dtparam</span><span class="o">=</span><span class="s">pciex1_gen=2</span>
<span class="k">[all]</span>
<span class="na">arm_64bit</span><span class="o">=</span><span class="s">0</span>
<span class="na">dtparam</span><span class="o">=</span><span class="s">audio=on</span>
<span class="na">audio_pwm_mode</span><span class="o">=</span><span class="s">2</span>
<span class="na">dtparam</span><span class="o">=</span><span class="s">i2c_arm=on</span>
<span class="na">disable_splash</span><span class="o">=</span><span class="s">1</span>
<span class="na">hdmi_force_hotplug</span><span class="o">=</span><span class="s">1</span>
<span class="na">force_eeprom_read</span><span class="o">=</span><span class="s">0</span>
</code></pre></div>

<h2>Installing ArchLinux ARM</h2>
<details>
<summary>So I followed the basic install guide.</summary>


<div class="highlight"><pre><span></span><code>[alarm@alarmpi ~]$ su
Password:
[root@alarmpi alarm]# pacman-key --init
gpg: /etc/pacman.d/gnupg/trustdb.gpg: trustdb created
gpg: no ultimately trusted keys found
gpg: starting migration from earlier GnuPG versions
gpg: porting secret keys from &#39;/etc/pacman.d/gnupg/secring.gpg&#39; to gpg-agent
gpg: migration succeeded
==&gt; Generating pacman master key. This may take some time.
gpg: Generating pacman keyring master key...
gpg: directory &#39;/etc/pacman.d/gnupg/openpgp-revocs.d&#39; created
gpg: revocation certificate stored as &#39;/etc/pacman.d/gnupg/openpgp-revocs.d/8277D1E09B6B70944D92CD089C16C729F5655E65.rev&#39;
gpg: Done
==&gt; Updating trust database...
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
[root@alarmpi alarm]# pacman-key --populate archlinuxarm
==&gt; Appending keys from archlinuxarm.gpg...
==&gt; Locally signing trusted keys in keyring...
  -&gt; Locally signed 3 keys.
==&gt; Importing owner trust values...
gpg: setting ownertrust to 4
gpg: inserting ownertrust of 4
gpg: setting ownertrust to 4
==&gt; Updating trust database...
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   3  trust: 0-, 0q, 0n, 0m, 0f, 1u
gpg: depth: 1  valid:   3  signed:   1  trust: 0-, 0q, 0n, 3m, 0f, 0u
gpg: depth: 2  valid:   1  signed:   0  trust: 1-, 0q, 0n, 0m, 0f, 0u
[root@alarmpi alarm]# pacman -Syu
:: Synchronizing package databases...
 core                            240.3 KiB   215 KiB/s 00:01 [################################] 100%
 extra                             9.0 MiB  5.62 MiB/s 00:02 [################################] 100%
 community                        45.0   B   236   B/s 00:00 [################################] 100%
 alarm                            94.9 KiB   474 KiB/s 00:00 [################################] 100%
 aur                               9.3 KiB  49.1 KiB/s 00:00 [################################] 100%
:: Starting full system upgrade...
:: Replace raspberrypi-firmware with alarm/raspberrypi-utils? [Y/n]
</code></pre></div>



</details>

<p>I then changed the hostname to avoid the conflict with my existing archlinuxarm
machine in the network and rebooted:</p>
<div class="highlight"><pre><span></span><code>[root@alarmpi alarm]# hostnamectl hostname muzikskatolo
[root@alarmpi alarm]# reboot
</code></pre></div>

<h2>Setting up the network</h2>
<p>To get wifi running I installed <code>iwd</code>:</p>
<div class="highlight"><pre><span></span><code>[root@muzikskatolo alarm]# pacman -S iwd
[root@muzikskatolo alarm]# systemctl enable iwd.service
[root@muzikskatolo alarm]# systemctl start iwd.service
</code></pre></div>

<p>Then connected to my wifi</p>
<div class="highlight"><pre><span></span><code>[root@muzikskatolo alarm]# iwctl
NetworkConfigurationEnabled: disabled
StateDirectory: /var/lib/iwd
Version: 2.19
[iwd]# station wlan0 scan
[iwd]# station wlan0 connect wifi-ssid
Type the network passphrase for wifi-ssid psk.
Passphrase:
</code></pre></div>

<p>And configured systemd to start DHCP for the interface by creating
<code>/etc/systemd/network/wlan0.network</code> with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="k">[Match]</span>
<span class="na">Name</span><span class="o">=</span><span class="s">wlan0</span>

<span class="k">[Network]</span>
<span class="na">DHCP</span><span class="o">=</span><span class="s">yes</span>
<span class="na">IgnoreCarrierLoss</span><span class="o">=</span><span class="s">3s</span>
</code></pre></div>

<p>Followed by</p>
<div class="highlight"><pre><span></span><code>[root@muzikskatolo alarm]# systemctl reload systemd-networkd.service
</code></pre></div>

<p>Also I disabled waiting for all networks to be online, since the Pi will only
have wifi were I want to place it:</p>
<div class="highlight"><pre><span></span><code>[root@muzikskatolo alarm]# systemctl disable systemd-networkd-wait-online.service
[root@muzikskatolo alarm]# systemctl enable systemd-networkd-wait-online@wlan0.service
</code></pre></div>

<h2>Enabling the Audio</h2>
<p>To get the amp running I enabled the <code>hifiberry-dacplus</code> <code>dtoverlay</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># https://www.hifiberry.com/docs/data-sheets/datasheet-amp2/</span>
<span class="na">dtoverlay</span><span class="o">=</span><span class="s">hifiberry-dacplus,slave</span>
</code></pre></div>

<p>For the next step I powered down and hooked up the Raspberry Pi to the
hardware.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="http://www.coredump.ch/">coredump</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://blog.rnstlr.ch/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/rnstlr">twitter</a></li>
                            <li><a href="https://github.com/rnestler">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>